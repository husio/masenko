<!doctype html>
<html>
<head>
  <title>Task Queue</title>
<style>
html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
#queues { display: flex; justify-content: space-around; align-items: center; height: 60%; width: 100%; flex-direction: row;}
#queues .info {}
#queues .graph { display: flex; width: 200px; height: 80px;}
#queues .graph .bar { width: 100%; margin: 0; padding: 0; display: inline-block; align-self: flex-end; }
</style>
</head>
<body>
  <div id="queues"></div>
  <code id="info"></code>
</body>
<script>
window.addEventListener("load", function() {
  var queues = document.getElementById("queues")


  function Graph(node, name, color) {
    var n = document.createElement("div")
    n.classList.add("graph")
    node.appendChild(n)

    this.label = document.createElement("span")
    this.label.innerHTML = name + " 0"
    node.appendChild(this.label)

    this.node = n
    this.name = name
    this.color = color
    this.maxval = 0
    this.maxitems = 60
    this.bars = []
  }

  Graph.prototype = {
    add: function(value) {
      if (value > this.maxval) {
        this.maxval = value * 1.25
        var maxval = this.maxval
        this.bars.forEach(function(b) {
          var h = b.getAttribute("value") / maxval * 100
          b.title = h
          b.style.height = h + "%"
        })
      }

      var b = document.createElement("span")
      b.classList.add("bar")
      b.style.height = (value / this.maxval) * 100 + "%"
      b.style.background = this.color
      b.title = value
      b.setAttribute("value", value)
      this.node.appendChild(b)
      this.bars.push(b)

      if (this.bars.length > this.maxitems) {
        this.node.removeChild(this.bars.shift())
      }

      this.label.innerHTML = this.name + " " + value
    }
  }

  function stats(cb) {
    var req = new XMLHttpRequest();
    req.open('GET', '/stats.json', true);
    req.onload = function() {
      if (this.status === 200) {
        cb(JSON.parse(this.response))
      }
    }
    req.send()
  }

  var info = document.getElementById("info")

  var graphs = {}

  function pullStats() {
    stats(function(data) {

      info.innerHTML = JSON.stringify(data)

      data.queues.forEach(function(q) {
        var set = graphs[q.name]

        if (!graphs[q.name]) {
          set = {}
          graphs[q.name] = set

          var info = document.createElement("div")
          info.classList.add("queue")
          queues.appendChild(info)

          var nready = document.createElement("div")
          nready.classList.add("graph")
          info.appendChild(nready)
          set.ready = new Graph(nready, "Ready", "#8FC77D")

          var ndelayed = document.createElement("div")
          ndelayed.classList.add("graph")
          info.appendChild(ndelayed)
          set.delayed = new Graph(ndelayed, "Delayed", "#C77DBF")

          var ntoack = document.createElement("div")
          ntoack.classList.add("graph")
          info.appendChild(ntoack)
          set.to_ack = new Graph(ntoack, "To ACK", "#E9A37F")
        }

        set.ready.add(q.ready)
        set.delayed.add(q.delayed)
        set.to_ack.add(q.to_ack)
      })

      setTimeout(pullStats, 1000)
    })
  }

  pullStats()
})

</script>
</html>
