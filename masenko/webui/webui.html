<!doctype html>
<html>
<head>
  <title>Task Queue</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/js/mithril.js"></script>
<style>
html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
#queues { display: flex; justify-content: space-around; align-items: center; height: 60%; width: 100%; flex-direction: row;}
#queues .info {}
#queues .graph { display: flex; width: 200px; height: 80px;}
#queues .graph .bar { width: 100%; margin: 0; padding: 0; display: inline-block; align-self: flex-end; }
</style>
</head>
<body>
  <div id="queues"></div>
  <code id="info"></code>
</body>
<script>
var QueueList = {
  queues: [],
  all: function() { return Object.values(QueueList.queues) },
  loadQueues: function() {
    return m.request({method: "GET", url: "/stats.json"})
      .then(function(result) {
        result.queues.forEach(function(data) {
          var queue = QueueList.queues[data.name]
          if (!queue) {
            queue = {
              maxval: 10,
              ready: [],
              to_ack: [],
              delayed: [],
              name: data.name,
            }
            QueueList.queues[data.name] = queue
          }
          queue.ready.push(data.ready)
          queue.to_ack.push(data.to_ack)
          queue.delayed.push(data.delayed)

          queue.maxval = Math.max(queue.maxval, data.ready, data.to_ack, data.delayed)

          if (queue.ready.length > 50) { queue.ready.shift() }
          if (queue.to_ack.length > 50) { queue.to_ack.shift() }
          if (queue.delayed.length > 50) { queue.delayed.shift() }
        })
      })
  },
}

setInterval(QueueList.loadQueues, 1000)

var QueuesView = {
  oninit: QueueList.loadQueues,
  view: function() {
    return m("div", {className: "queues"}, QueueList.all().map(function(q) {
      return m("div", [
        q.name,
        m("div", {className: "graph"}, q.ready.map(function(val) {
            return m("span", {className: "bar", style: {height: (val / q.maxval) * 100 + "%", background: "#6EC960"}})
          }),
          q.ready[q.ready.length - 1],
        ),
        m("div", {className: "graph"}, q.to_ack.map(function(val) {
            return m("span", {className: "bar", style: {height: (val / q.maxval) * 100 + "%", background: "#C0C960"}})
          }),
          q.to_ack[q.to_ack.length - 1],
        ),
        m("div", {className: "graph"}, q.delayed.map(function(val) {
            return m("span", {className: "bar", style: {height: (val / q.maxval) * 100 + "%", background: "#C18DC8"}})
          }),
          q.delayed[q.delayed.length - 1],
        )
      ])
    }))
  }
}

window.addEventListener("load", function() {
  var queues = document.getElementById("queues")
  m.mount(queues, QueuesView)
})

</script>
</html>
