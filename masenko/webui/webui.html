<!doctype html>
<html>
<head>
  <title>Task Queue</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="/js/mithril.js"></script>
<style>
html, body { margin: 0; padding: 0; height: 100%; width: 100%; }
#app .row { display: flex; width: 100%; justify-content: space-around; }
#app .graph { border: 1px solid #DCDCDC; width: 200px; height: 80px; display: flex;}
#app .graph .bar { display: flex; width: 100%; max-width: 10px; margin: 0; padding: 0; align-self: flex-end; align-items: center; flex-direction: row; }
#app .graph .bar:hover { background: black !important; }
</style>
</head>
<body>
  <div id="app"></div>
  <code id="info"></code>
</body>
<script>
var Stats = {
  _queues: {},
  _metrics: {},

  queues: function() {
    return Object.values(Stats._queues).sort()
  },
  metrics: function() {
    return Object.entries(Stats._metrics).sort().map(function(pair) {
      return {name: pair[0], value: pair[1]}
    })
  },
  refresh: function() {
    return m.request({method: "GET", url: "/stats.json"})
      .then(function(result) {

        Stats._metrics = result.metrics

        result.queues.forEach(function(data) {
          var queue = Stats._queues[data.name]
          if (!queue) {
            queue = {
              maxval: 10,
              ready: [],
              to_ack: [],
              delayed: [],
              name: data.name,
            }
            Stats._queues[data.name] = queue
          }
          queue.ready.push(data.ready)
          queue.to_ack.push(data.to_ack)
          queue.delayed.push(data.delayed)

          queue.maxval = Math.max(queue.maxval, data.ready, data.to_ack, data.delayed)

          if (queue.ready.length > 50) { queue.ready.shift() }
          if (queue.to_ack.length > 50) { queue.to_ack.shift() }
          if (queue.delayed.length > 50) { queue.delayed.shift() }
        })
      })
  },
}

setInterval(Stats.refresh, 1500)

var App = {
  oninit: Stats.loadQueues,
  view: function() {
    return [
      renderQueueListView(Stats.queues()),
      renderMetrics(Stats.metrics()),
    ]
  }
}


function renderMetrics(metrics) {
  return m("table", [
    m("thead",
      m("tr", [
        m("th", "Name"),
        m("th", "Value"),
      ])
    ),
    metrics.map(function(metric) {
      return m("tr", [
        m("td", metric.name),
        m("td", metric.value),
      ])
    }),
  ])
}


function renderQueueListView(queues) {
  return m("table", [
    m("thead",
      m("tr", [
        m("th", "Queue name"),
        m("th", "Ready"),
        m("th", "To ACK"),
        m("th", "Delayed"),
      ]),
    ),
    ], queues.map(function(q) {
    return m("tr", [
      m("td", [
        q.name,
      ]),
      m("td",
        m("div", {className: "graph"}, q.ready.map(function(val) {
            return m("span", {className: "bar", style: {height: (val / q.maxval) * 100 + "%", background: "#6EC960"}, title: val})
          }),
        )
      ),
      m("td",
        m("div", {className: "graph"}, q.to_ack.map(function(val) {
            return m("span", {className: "bar", style: {height: (val / q.maxval) * 100 + "%", background: "#C0C960"}, title: val})
          }),
        ),
      ),
      m("td",
        m("div", {className: "graph"}, q.delayed.map(function(val) {
            return m("span", {className: "bar", style: {height: (val / q.maxval) * 100 + "%", background: "#C18DC8"}, title: val})
          }),
        ),
      )
    ])
  }))
}


window.addEventListener("load", function() {
  var queues = document.getElementById("app")
  m.mount(queues, App)
})

</script>
</html>
