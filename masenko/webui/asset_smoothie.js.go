// File generated with inlineasset 2020-06-14 05:45:47.909173933 +0000 UTC.
package webui

import "encoding/base64"

var WebUISmoothieJS, _ = base64.StdEncoding.DecodeString("Ly8gTUlUIExpY2Vuc2U6Ci8vCi8vIENvcHlyaWdodCAoYykgMjAxMC0yMDEzLCBKb2UgV2FsbmVzCi8vICAgICAgICAgICAgICAgMjAxMy0yMDE3LCBEcmV3IE5vYWtlcwovLwovLyBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5Ci8vIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsCi8vIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHMKLy8gdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbAovLyBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMKLy8gZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczoKLy8KLy8gVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4KLy8gYWxsIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuCi8vCi8vIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SCi8vIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLAovLyBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEUKLy8gQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUgovLyBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLAovLyBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOCi8vIFRIRSBTT0ZUV0FSRS4KCi8qKgogKiBTbW9vdGhpZSBDaGFydHMgLSBodHRwOi8vc21vb3RoaWVjaGFydHMub3JnLwogKiAoYykgMjAxMC0yMDEzLCBKb2UgV2FsbmVzCiAqICAgICAyMDEzLTIwMTcsIERyZXcgTm9ha2VzCiAqCiAqIHYxLjA6IE1haW4gY2hhcnRpbmcgbGlicmFyeSwgYnkgSm9lIFdhbG5lcwogKiB2MS4xOiBBdXRvIHNjYWxpbmcgb2YgYXhpcywgYnkgTmVpbCBEdW5uCiAqIHYxLjI6IGZwcyAoZnJhbWVzIHBlciBzZWNvbmQpIG9wdGlvbiwgYnkgTWF0aGlhcyBQZXR0ZXJzb24KICogdjEuMzogRml4IGZvciBkaXZpZGUgYnkgemVybywgYnkgUGF1bCBOaWtpdG9jaGtpbgogKiB2MS40OiBTZXQgbWluaW11bSwgdG9wLXNjYWxlIHBhZGRpbmcsIHJlbW92ZSB0aW1lc2VyaWVzLCBhZGQgb3B0aW9uYWwgdGltZXIgdG8gcmVzZXQgYm91bmRzLCBieSBLZWxsZXkgUmV5bm9sZHMKICogdjEuNTogU2V0IGRlZmF1bHQgZnJhbWVzIHBlciBzZWNvbmQgdG8gNTAuLi4gc21vb3RoZXIuCiAqICAgICAgIC5zdGFydCgpLCAuc3RvcCgpIG1ldGhvZHMgZm9yIGNvbnNlcnZpbmcgQ1BVLCBieSBEbWl0cnkgVnlhbAogKiAgICAgICBvcHRpb25zLmludGVycG9sYXRpb24gPSAnYmV6aWVyJyBvciAnbGluZScsIGJ5IERtaXRyeSBWeWFsCiAqICAgICAgIG9wdGlvbnMubWF4VmFsdWUgdG8gZml4IHNjYWxlLCBieSBEbWl0cnkgVnlhbAogKiB2MS42OiBtaW5WYWx1ZS9tYXhWYWx1ZSB3aWxsIGFsd2F5cyBnZXQgY29udmVydGVkIHRvIGZsb2F0cywgYnkgUHJ6ZW1layBNYXR5bGxhCiAqIHYxLjc6IG9wdGlvbnMuZ3JpZC5maWxsU3R5bGUgbWF5IGJlIGEgdHJhbnNwYXJlbnQgY29sb3IsIGJ5IERtaXRyeSBBLiBTaGFzaGtpbgogKiAgICAgICBTbW9vdGggcmVzY2FsaW5nLCBieSBLb3N0YXMgTWljaGFsb3BvdWxvcwogKiB2MS44OiBTZXQgbWF4IGxlbmd0aCB0byBjdXN0b21pemUgbnVtYmVyIG9mIGxpdmUgcG9pbnRzIGluIHRoZSBkYXRhc2V0IHdpdGggb3B0aW9ucy5tYXhEYXRhU2V0TGVuZ3RoLCBieSBLcmlzaG5hIE5hcm5pCiAqIHYxLjk6IERpc3BsYXkgdGltZXN0YW1wcyBhbG9uZyB0aGUgYm90dG9tLCBieSBOaWNrIGFuZCBTdGV2LWlvCiAqICAgICAgIChodHRwczovL2dyb3Vwcy5nb29nbGUuY29tL2ZvcnVtLz9mcm9tZ3JvdXBzIyF0b3BpYy9zbW9vdGhpZS1jaGFydHMvLVl3c2U4RkNwS0klNUIxLTI1JTVEKQogKiAgICAgICBSZWZhY3RvcmVkIGJ5IEtyaXNobmEgTmFybmksIHRvIHN1cHBvcnQgdGltZXN0YW1wIGZvcm1hdHRpbmcgZnVuY3Rpb24KICogdjEuMTA6IFN3aXRjaCB0byByZXF1ZXN0QW5pbWF0aW9uRnJhbWUsIHJlbW92ZWQgdGhlIG5vdyBvYnNvbGV0ZWQgb3B0aW9ucy5mcHMsIGJ5IEdlcmdlbHkgSW1yZWgKICogdjEuMTE6IG9wdGlvbnMuZ3JpZC5zaGFycExpbmVzIG9wdGlvbiBhZGRlZCwgYnkgQGRyZXdub2FrZXMKICogICAgICAgIEFkZHJlc3NlZCB3YXJuaW5nIHNlZW4gaW4gRmlyZWZveCB3aGVuIHNlcmllc09wdGlvbi5maWxsU3R5bGUgdW5kZWZpbmVkLCBieSBAZHJld25vYWtlcwogKiB2MS4xMjogU3VwcG9ydCBmb3IgaG9yaXpvbnRhbExpbmVzIGFkZGVkLCBieSBAZHJld25vYWtlcwogKiAgICAgICAgU3VwcG9ydCBmb3IgeVJhbmdlRnVuY3Rpb24gY2FsbGJhY2sgYWRkZWQsIGJ5IEBkcmV3bm9ha2VzCiAqIHYxLjEzOiBGaXhlZCB0eXBvICgjMzIpLCBieSBAYWxuaWtpdGljaAogKiB2MS4xNDogVGltZXIgY2xlYXJlZCB3aGVuIGxhc3QgVGltZVNlcmllcyByZW1vdmVkICgjMjMpLCBieSBAZGF2aWRnYWxlYW5vCiAqICAgICAgICBGaXhlZCBkaWFnb25hbCBsaW5lIG9uIGNoYXJ0IGF0IHN0YXJ0L2VuZCBvZiBkYXRhIHN0cmVhbSwgYnkgQGRyZXdub2FrZXMKICogdjEuMTU6IFN1cHBvcnQgZm9yIG5wbSBwYWNrYWdlICgjMTgpLCBieSBAZG9taW5pY3RhcnIKICogICAgICAgIEZpeGVkIGJyb2tlbiByZW1vdmVUaW1lU2VyaWVzIGZ1bmN0aW9uICgjMjQpIGJ5IEBkYXZpZGdhbGVhbm8KICogICAgICAgIE1pbm9yIHBlcmZvcm1hbmNlIGFuZCB0aWR5aW5nLCBieSBAZHJld25vYWtlcwogKiB2MS4xNjogQnVnIGZpeCBpbnRyb2R1Y2VkIGluIHYxLjE0IHJlbGF0aW5nIHRvIHRpbWVyIGNyZWF0aW9uL2NsZWFyYW5jZSAoIzIzKSwgYnkgQGRyZXdub2FrZXMKICogICAgICAgIFRpbWVTZXJpZXMuYXBwZW5kIG5vdyBkZWFscyB3aXRoIG91dC1vZi1vcmRlciB0aW1lc3RhbXBzLCBhbmQgY2FuIG1lcmdlIGR1cGxpY2F0ZXMsIGJ5IEB6YWN3aXR0ZSAoIzEyKQogKiAgICAgICAgRG9jdW1lbnRhdGlvbiBhbmQgc29tZSBsb2NhbCB2YXJpYWJsZSByZW5hbWluZyBmb3IgY2xhcml0eSwgYnkgQGRyZXdub2FrZXMKICogdjEuMTc6IEFsbG93IGNvbnRyb2wgb3ZlciBmb250IHNpemUgKCMxMCksIGJ5IEBkcmV3bm9ha2VzCiAqICAgICAgICBUaW1lc3RhbXAgdGV4dCB3b24ndCBvdmVybGFwLCBieSBAZHJld25vYWtlcwogKiB2MS4xODogQWxsb3cgY29udHJvbCBvZiBtYXgvbWluIGxhYmVsIHByZWNpc2lvbiwgYnkgQGRyZXdub2FrZXMKICogICAgICAgIEFkZGVkICdib3JkZXJWaXNpYmxlJyBjaGFydCBvcHRpb24sIGJ5IEBkcmV3bm9ha2VzCiAqICAgICAgICBBbGxvdyBkcmF3aW5nIHNlcmllcyB3aXRoIGZpbGwgYnV0IG5vIHN0cm9rZSAobGluZSksIGJ5IEBkcmV3bm9ha2VzCiAqIHYxLjE5OiBBdm9pZCB1bm5lY2Vzc2FyeSByZXBhaW50cywgYW5kIGZpeGVkIGZsaWNrZXIgaW4gb2xkIGJyb3dzZXJzIGhhdmluZyBtdWx0aXBsZSBjaGFydHMgaW4gZG9jdW1lbnQgKCM0MCksIGJ5IEBhc2JhaQogKiB2MS4yMDogQWRkIFNtb290aGllQ2hhcnQuZ2V0VGltZVNlcmllc09wdGlvbnMgYW5kIFNtb290aGllQ2hhcnQuYnJpbmdUb0Zyb250IGZ1bmN0aW9ucywgYnkgQGRyZXdub2FrZXMKICogdjEuMjE6IEFkZCAnc3RlcCcgaW50ZXJwb2xhdGlvbiBtb2RlLCBieSBAZHJld25vYWtlcwogKiB2MS4yMjogQWRkIHN1cHBvcnQgZm9yIGRpZmZlcmVudCBwaXhlbCByYXRpb3MuIEFsc28gYWRkIG9wdGlvbmFsIHkgbGltaXQgZm9ybWF0dGVycywgYnkgQGNvcGFjZXRpYwogKiB2MS4yMzogRml4IGJ1ZyBpbnRyb2R1Y2VkIGluIHYxLjIyICgjNDQpLCBieSBAZHJld25vYWtlcwogKiB2MS4yNDogRml4IGJ1ZyBpbnRyb2R1Y2VkIGluIHYxLjIzLCByZS1hZGRpbmcgcGFyc2VGbG9hdCB0byB5LWF4aXMgZm9ybWF0dGVyIGRlZmF1bHRzLCBieSBAc2lnZ3lfc2YKICogdjEuMjU6IEZpeCBidWcgc2VlbiB3aGVuIGFkZGluZyBhIGRhdGEgcG9pbnQgdG8gVGltZVNlcmllcyB3aGljaCBpcyBvbGRlciB0aGFuIHRoZSBjdXJyZW50IGRhdGEsIGJ5IEBOa2luZzkyCiAqICAgICAgICBEcmF3IHRpbWUgbGFiZWxzIG9uIHRvcCBvZiBzZXJpZXMsIGJ5IEBjb21vbG9zYWJpYQogKiAgICAgICAgQWRkIFRpbWVTZXJpZXMuY2xlYXIgZnVuY3Rpb24sIGJ5IEBkcmV3bm9ha2VzCiAqIHYxLjI2OiBBZGQgc3VwcG9ydCBmb3IgcmVzaXppbmcgb24gaGlnaCBkZXZpY2UgcGl4ZWwgcmF0aW8gc2NyZWVucywgYnkgQGNvcGFjZXRpYwogKiB2MS4yNzogRml4IGJ1ZyBpbnRyb2R1Y2VkIGluIHYxLjI2IGZvciBub24gd2hvbGUgbnVtYmVyIGRldmljZVBpeGVsUmF0aW8gdmFsdWVzLCBieSBAem1idXNoCiAqIHYxLjI4OiBBZGQgJ21pblZhbHVlU2NhbGUnIG9wdGlvbiwgYnkgQG1lZ2F3YWMKICogICAgICAgIEZpeCAnbGFiZWxQb3MnIGZvciBkaWZmZXJlbnQgc2l6ZSBvZiAnbWluVmFsdWVTdHJpbmcnICdtYXhWYWx1ZVN0cmluZycsIGJ5IEBoZW5yeW4KICogdjEuMjk6IFN1cHBvcnQgcmVzcG9uc2l2ZSBzaXppbmcsIGJ5IEBkcmV3bm9ha2VzCiAqIHYxLjI5LjE6IEluY2x1ZGUgdHlwZXMgaW4gcGFja2FnZSwgYW5kIG1ha2UgcHJvcGVydHkgb3B0aW9uYWwsIGJ5IEBUcmVudEhvdWxpc3RvbgogKiB2MS4zMDogRml4IGludmVydGVkIGxvZ2ljIGluIGRldmljZVBpeGVsUmF0aW8gc3VwcG9ydCwgYnkgQHNjYW5saW1lCiAqIHYxLjMxOiBTdXBwb3J0IHRvb2x0aXBzLCBieSBAU2x5MTAyNCBhbmQgQGRyZXdub2FrZXMKICogdjEuMzI6IFN1cHBvcnQgZnJhbWUgcmF0ZSBsaW1pdCwgYnkgQGRwdXlvc2EKICogdjEuMzM6IFVzZSBEYXRlIHN0YXRpYyBtZXRob2QgaW5zdGVhZCBvZiBpbnN0YW5jZSwgYnkgQG5ubm9lbAogKiAgICAgICAgRml4IGJ1ZyB3aXRoIHRvb2x0aXBzIHdoZW4gbXVsdGlwbGUgY2hhcnRzIG9uIGEgcGFnZSwgYnkgQGpwbWJpejcwCiAqLwoKOyhmdW5jdGlvbihleHBvcnRzKSB7CgogIC8vIERhdGUubm93IHBvbHlmaWxsCiAgRGF0ZS5ub3cgPSBEYXRlLm5vdyB8fCBmdW5jdGlvbigpIHsgcmV0dXJuIG5ldyBEYXRlKCkuZ2V0VGltZSgpOyB9OwoKICB2YXIgVXRpbCA9IHsKICAgIGV4dGVuZDogZnVuY3Rpb24oKSB7CiAgICAgIGFyZ3VtZW50c1swXSA9IGFyZ3VtZW50c1swXSB8fCB7fTsKICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspCiAgICAgIHsKICAgICAgICBmb3IgKHZhciBrZXkgaW4gYXJndW1lbnRzW2ldKQogICAgICAgIHsKICAgICAgICAgIGlmIChhcmd1bWVudHNbaV0uaGFzT3duUHJvcGVydHkoa2V5KSkKICAgICAgICAgIHsKICAgICAgICAgICAgaWYgKHR5cGVvZihhcmd1bWVudHNbaV1ba2V5XSkgPT09ICdvYmplY3QnKSB7CiAgICAgICAgICAgICAgaWYgKGFyZ3VtZW50c1tpXVtrZXldIGluc3RhbmNlb2YgQXJyYXkpIHsKICAgICAgICAgICAgICAgIGFyZ3VtZW50c1swXVtrZXldID0gYXJndW1lbnRzW2ldW2tleV07CiAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGFyZ3VtZW50c1swXVtrZXldID0gVXRpbC5leHRlbmQoYXJndW1lbnRzWzBdW2tleV0sIGFyZ3VtZW50c1tpXVtrZXldKTsKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgYXJndW1lbnRzWzBdW2tleV0gPSBhcmd1bWVudHNbaV1ba2V5XTsKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgICByZXR1cm4gYXJndW1lbnRzWzBdOwogICAgfSwKICAgIGJpbmFyeVNlYXJjaDogZnVuY3Rpb24oZGF0YSwgdmFsdWUpIHsKICAgICAgdmFyIGxvdyA9IDAsCiAgICAgICAgICBoaWdoID0gZGF0YS5sZW5ndGg7CiAgICAgIHdoaWxlIChsb3cgPCBoaWdoKSB7CiAgICAgICAgdmFyIG1pZCA9IChsb3cgKyBoaWdoKSA+PiAxOwogICAgICAgIGlmICh2YWx1ZSA8IGRhdGFbbWlkXVswXSkKICAgICAgICAgIGhpZ2ggPSBtaWQ7CiAgICAgICAgZWxzZQogICAgICAgICAgbG93ID0gbWlkICsgMTsKICAgICAgfQogICAgICByZXR1cm4gbG93OwogICAgfQogIH07CgogIC8qKgogICAqIEluaXRpYWxpc2VzIGEgbmV3IDxjb2RlPlRpbWVTZXJpZXM8L2NvZGU+IHdpdGggb3B0aW9uYWwgZGF0YSBvcHRpb25zLgogICAqCiAgICogT3B0aW9ucyBhcmUgb2YgdGhlIGZvcm0gKGRlZmF1bHRzIHNob3duKToKICAgKgogICAqIDxwcmU+CiAgICogewogICAqICAgcmVzZXRCb3VuZHM6IHRydWUsICAgICAgICAvLyBlbmFibGVzL2Rpc2FibGVzIGF1dG9tYXRpYyBzY2FsaW5nIG9mIHRoZSB5LWF4aXMKICAgKiAgIHJlc2V0Qm91bmRzSW50ZXJ2YWw6IDMwMDAgLy8gdGhlIHBlcmlvZCBiZXR3ZWVuIHNjYWxpbmcgY2FsY3VsYXRpb25zLCBpbiBtaWxsaXMKICAgKiB9CiAgICogPC9wcmU+CiAgICoKICAgKiBQcmVzZW50YXRpb24gb3B0aW9ucyBmb3IgVGltZVNlcmllcyBhcmUgc3BlY2lmaWVkIGFzIGFuIGFyZ3VtZW50IHRvIDxjb2RlPlNtb290aGllQ2hhcnQuYWRkVGltZVNlcmllczwvY29kZT4uCiAgICoKICAgKiBAY29uc3RydWN0b3IKICAgKi8KICBmdW5jdGlvbiBUaW1lU2VyaWVzKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IFV0aWwuZXh0ZW5kKHt9LCBUaW1lU2VyaWVzLmRlZmF1bHRPcHRpb25zLCBvcHRpb25zKTsKICAgIHRoaXMuY2xlYXIoKTsKICB9CgogIFRpbWVTZXJpZXMuZGVmYXVsdE9wdGlvbnMgPSB7CiAgICByZXNldEJvdW5kc0ludGVydmFsOiAzMDAwLAogICAgcmVzZXRCb3VuZHM6IHRydWUKICB9OwoKICAvKioKICAgKiBDbGVhcnMgYWxsIGRhdGEgYW5kIHN0YXRlIGZyb20gdGhpcyBUaW1lU2VyaWVzIG9iamVjdC4KICAgKi8KICBUaW1lU2VyaWVzLnByb3RvdHlwZS5jbGVhciA9IGZ1bmN0aW9uKCkgewogICAgdGhpcy5kYXRhID0gW107CiAgICB0aGlzLm1heFZhbHVlID0gTnVtYmVyLk5hTjsgLy8gVGhlIG1heGltdW0gdmFsdWUgZXZlciBzZWVuIGluIHRoaXMgVGltZVNlcmllcy4KICAgIHRoaXMubWluVmFsdWUgPSBOdW1iZXIuTmFOOyAvLyBUaGUgbWluaW11bSB2YWx1ZSBldmVyIHNlZW4gaW4gdGhpcyBUaW1lU2VyaWVzLgogIH07CgogIC8qKgogICAqIFJlY2FsY3VsYXRlIHRoZSBtaW4vbWF4IHZhbHVlcyBmb3IgdGhpcyA8Y29kZT5UaW1lU2VyaWVzPC9jb2RlPiBvYmplY3QuCiAgICoKICAgKiBUaGlzIGNhdXNlcyB0aGUgZ3JhcGggdG8gc2NhbGUgaXRzZWxmIGluIHRoZSB5LWF4aXMuCiAgICovCiAgVGltZVNlcmllcy5wcm90b3R5cGUucmVzZXRCb3VuZHMgPSBmdW5jdGlvbigpIHsKICAgIGlmICh0aGlzLmRhdGEubGVuZ3RoKSB7CiAgICAgIC8vIFdhbGsgdGhyb3VnaCBhbGwgZGF0YSBwb2ludHMsIGZpbmRpbmcgdGhlIG1pbi9tYXggdmFsdWUKICAgICAgdGhpcy5tYXhWYWx1ZSA9IHRoaXMuZGF0YVswXVsxXTsKICAgICAgdGhpcy5taW5WYWx1ZSA9IHRoaXMuZGF0YVswXVsxXTsKICAgICAgZm9yICh2YXIgaSA9IDE7IGkgPCB0aGlzLmRhdGEubGVuZ3RoOyBpKyspIHsKICAgICAgICB2YXIgdmFsdWUgPSB0aGlzLmRhdGFbaV1bMV07CiAgICAgICAgaWYgKHZhbHVlID4gdGhpcy5tYXhWYWx1ZSkgewogICAgICAgICAgdGhpcy5tYXhWYWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICBpZiAodmFsdWUgPCB0aGlzLm1pblZhbHVlKSB7CiAgICAgICAgICB0aGlzLm1pblZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICAvLyBObyBkYXRhIGV4aXN0cywgc28gc2V0IG1pbi9tYXggdG8gTmFOCiAgICAgIHRoaXMubWF4VmFsdWUgPSBOdW1iZXIuTmFOOwogICAgICB0aGlzLm1pblZhbHVlID0gTnVtYmVyLk5hTjsKICAgIH0KICB9OwoKICAvKioKICAgKiBBZGRzIGEgbmV3IGRhdGEgcG9pbnQgdG8gdGhlIDxjb2RlPlRpbWVTZXJpZXM8L2NvZGU+LCBwcmVzZXJ2aW5nIGNocm9ub2xvZ2ljYWwgb3JkZXIuCiAgICoKICAgKiBAcGFyYW0gdGltZXN0YW1wIHRoZSBwb3NpdGlvbiwgaW4gdGltZSwgb2YgdGhpcyBkYXRhIHBvaW50CiAgICogQHBhcmFtIHZhbHVlIHRoZSB2YWx1ZSBvZiB0aGlzIGRhdGEgcG9pbnQKICAgKiBAcGFyYW0gc3VtUmVwZWF0ZWRUaW1lU3RhbXBWYWx1ZXMgaWYgPGNvZGU+dGltZXN0YW1wPC9jb2RlPiBoYXMgYW4gZXhhY3QgbWF0Y2ggaW4gdGhlIHNlcmllcywgdGhpcyBmbGFnIGNvbnRyb2xzCiAgICogd2hldGhlciBpdCBpcyByZXBsYWNlZCwgb3IgdGhlIHZhbHVlcyBzdW1tZWQgKGRlZmF1bHRzIHRvIGZhbHNlLikKICAgKi8KICBUaW1lU2VyaWVzLnByb3RvdHlwZS5hcHBlbmQgPSBmdW5jdGlvbih0aW1lc3RhbXAsIHZhbHVlLCBzdW1SZXBlYXRlZFRpbWVTdGFtcFZhbHVlcykgewogICAgLy8gUmV3aW5kIHVudGlsIHdlIGhpdCBhbiBvbGRlciB0aW1lc3RhbXAKICAgIHZhciBpID0gdGhpcy5kYXRhLmxlbmd0aCAtIDE7CiAgICB3aGlsZSAoaSA+PSAwICYmIHRoaXMuZGF0YVtpXVswXSA+IHRpbWVzdGFtcCkgewogICAgICBpLS07CiAgICB9CgogICAgaWYgKGkgPT09IC0xKSB7CiAgICAgIC8vIFRoaXMgbmV3IGl0ZW0gaXMgdGhlIG9sZGVzdCBkYXRhCiAgICAgIHRoaXMuZGF0YS5zcGxpY2UoMCwgMCwgW3RpbWVzdGFtcCwgdmFsdWVdKTsKICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhLmxlbmd0aCA+IDAgJiYgdGhpcy5kYXRhW2ldWzBdID09PSB0aW1lc3RhbXApIHsKICAgICAgLy8gVXBkYXRlIGV4aXN0aW5nIHZhbHVlcyBpbiB0aGUgYXJyYXkKICAgICAgaWYgKHN1bVJlcGVhdGVkVGltZVN0YW1wVmFsdWVzKSB7CiAgICAgICAgLy8gU3VtIHRoaXMgdmFsdWUgaW50byB0aGUgZXhpc3RpbmcgJ2J1Y2tldCcKICAgICAgICB0aGlzLmRhdGFbaV1bMV0gKz0gdmFsdWU7CiAgICAgICAgdmFsdWUgPSB0aGlzLmRhdGFbaV1bMV07CiAgICAgIH0gZWxzZSB7CiAgICAgICAgLy8gUmVwbGFjZSB0aGUgcHJldmlvdXMgdmFsdWUKICAgICAgICB0aGlzLmRhdGFbaV1bMV0gPSB2YWx1ZTsKICAgICAgfQogICAgfSBlbHNlIGlmIChpIDwgdGhpcy5kYXRhLmxlbmd0aCAtIDEpIHsKICAgICAgLy8gU3BsaWNlIGludG8gdGhlIGNvcnJlY3QgcG9zaXRpb24gdG8ga2VlcCB0aW1lc3RhbXBzIGluIG9yZGVyCiAgICAgIHRoaXMuZGF0YS5zcGxpY2UoaSArIDEsIDAsIFt0aW1lc3RhbXAsIHZhbHVlXSk7CiAgICB9IGVsc2UgewogICAgICAvLyBBZGQgdG8gdGhlIGVuZCBvZiB0aGUgYXJyYXkKICAgICAgdGhpcy5kYXRhLnB1c2goW3RpbWVzdGFtcCwgdmFsdWVdKTsKICAgIH0KCiAgICB0aGlzLm1heFZhbHVlID0gaXNOYU4odGhpcy5tYXhWYWx1ZSkgPyB2YWx1ZSA6IE1hdGgubWF4KHRoaXMubWF4VmFsdWUsIHZhbHVlKTsKICAgIHRoaXMubWluVmFsdWUgPSBpc05hTih0aGlzLm1pblZhbHVlKSA/IHZhbHVlIDogTWF0aC5taW4odGhpcy5taW5WYWx1ZSwgdmFsdWUpOwogIH07CgogIFRpbWVTZXJpZXMucHJvdG90eXBlLmRyb3BPbGREYXRhID0gZnVuY3Rpb24ob2xkZXN0VmFsaWRUaW1lLCBtYXhEYXRhU2V0TGVuZ3RoKSB7CiAgICAvLyBXZSBtdXN0IGFsd2F5cyBrZWVwIG9uZSBleHBpcmVkIGRhdGEgcG9pbnQgYXMgd2UgbmVlZCB0aGlzIHRvIGRyYXcgdGhlCiAgICAvLyBsaW5lIHRoYXQgY29tZXMgaW50byB0aGUgY2hhcnQgZnJvbSB0aGUgbGVmdCwgYnV0IGFueSBwb2ludHMgcHJpb3IgdG8gdGhhdCBjYW4gYmUgcmVtb3ZlZC4KICAgIHZhciByZW1vdmVDb3VudCA9IDA7CiAgICB3aGlsZSAodGhpcy5kYXRhLmxlbmd0aCAtIHJlbW92ZUNvdW50ID49IG1heERhdGFTZXRMZW5ndGggJiYgdGhpcy5kYXRhW3JlbW92ZUNvdW50ICsgMV1bMF0gPCBvbGRlc3RWYWxpZFRpbWUpIHsKICAgICAgcmVtb3ZlQ291bnQrKzsKICAgIH0KICAgIGlmIChyZW1vdmVDb3VudCAhPT0gMCkgewogICAgICB0aGlzLmRhdGEuc3BsaWNlKDAsIHJlbW92ZUNvdW50KTsKICAgIH0KICB9OwoKICAvKioKICAgKiBJbml0aWFsaXNlcyBhIG5ldyA8Y29kZT5TbW9vdGhpZUNoYXJ0PC9jb2RlPi4KICAgKgogICAqIE9wdGlvbnMgYXJlIG9wdGlvbmFsLCBhbmQgc2hvdWxkIGJlIG9mIHRoZSBmb3JtIGJlbG93LiBKdXN0IHNwZWNpZnkgdGhlIHZhbHVlcyB5b3UKICAgKiBuZWVkIGFuZCB0aGUgcmVzdCB3aWxsIGJlIGdpdmVuIHNlbnNpYmxlIGRlZmF1bHRzIGFzIHNob3duOgogICAqCiAgICogPHByZT4KICAgKiB7CiAgICogICBtaW5WYWx1ZTogdW5kZWZpbmVkLCAgICAgICAgICAgICAgICAgICAgICAvLyBzcGVjaWZ5IHRvIGNsYW1wIHRoZSBsb3dlciB5LWF4aXMgdG8gYSBnaXZlbiB2YWx1ZQogICAqICAgbWF4VmFsdWU6IHVuZGVmaW5lZCwgICAgICAgICAgICAgICAgICAgICAgLy8gc3BlY2lmeSB0byBjbGFtcCB0aGUgdXBwZXIgeS1heGlzIHRvIGEgZ2l2ZW4gdmFsdWUKICAgKiAgIG1heFZhbHVlU2NhbGU6IDEsICAgICAgICAgICAgICAgICAgICAgICAgIC8vIGFsbG93cyBwcm9wb3J0aW9uYWwgcGFkZGluZyB0byBiZSBhZGRlZCBhYm92ZSB0aGUgY2hhcnQuIGZvciAxMCUgcGFkZGluZywgc3BlY2lmeSAxLjEuCiAgICogICBtaW5WYWx1ZVNjYWxlOiAxLCAgICAgICAgICAgICAgICAgICAgICAgICAvLyBhbGxvd3MgcHJvcG9ydGlvbmFsIHBhZGRpbmcgdG8gYmUgYWRkZWQgYmVsb3cgdGhlIGNoYXJ0LiBmb3IgMTAlIHBhZGRpbmcsIHNwZWNpZnkgMS4xLgogICAqICAgeVJhbmdlRnVuY3Rpb246IHVuZGVmaW5lZCwgICAgICAgICAgICAgICAgLy8gZnVuY3Rpb24oe21pbjogLCBtYXg6IH0pIHsgcmV0dXJuIHttaW46ICwgbWF4OiB9OyB9CiAgICogICBzY2FsZVNtb290aGluZzogMC4xMjUsICAgICAgICAgICAgICAgICAgICAvLyBjb250cm9scyB0aGUgcmF0ZSBhdCB3aGljaCB5LXZhbHVlIHpvb20gYW5pbWF0aW9uIG9jY3VycwogICAqICAgbWlsbGlzUGVyUGl4ZWw6IDIwLCAgICAgICAgICAgICAgICAgICAgICAgLy8gc2V0cyB0aGUgc3BlZWQgYXQgd2hpY2ggdGhlIGNoYXJ0IHBhbnMgYnkKICAgKiAgIGVuYWJsZURwaVNjYWxpbmc6IHRydWUsICAgICAgICAgICAgICAgICAgIC8vIHN1cHBvcnQgcmVuZGVyaW5nIGF0IGRpZmZlcmVudCBEUEkgZGVwZW5kaW5nIG9uIHRoZSBkZXZpY2UKICAgKiAgIHlNaW5Gb3JtYXR0ZXI6IGZ1bmN0aW9uKG1pbiwgcHJlY2lzaW9uKSB7IC8vIGNhbGxiYWNrIGZ1bmN0aW9uIHRoYXQgZm9ybWF0cyB0aGUgbWluIHkgdmFsdWUgbGFiZWwKICAgKiAgICAgcmV0dXJuIHBhcnNlRmxvYXQobWluKS50b0ZpeGVkKHByZWNpc2lvbik7CiAgICogICB9LAogICAqICAgeU1heEZvcm1hdHRlcjogZnVuY3Rpb24obWF4LCBwcmVjaXNpb24pIHsgLy8gY2FsbGJhY2sgZnVuY3Rpb24gdGhhdCBmb3JtYXRzIHRoZSBtYXggeSB2YWx1ZSBsYWJlbAogICAqICAgICByZXR1cm4gcGFyc2VGbG9hdChtYXgpLnRvRml4ZWQocHJlY2lzaW9uKTsKICAgKiAgIH0sCiAgICogICBtYXhEYXRhU2V0TGVuZ3RoOiAyLAogICAqICAgaW50ZXJwb2xhdGlvbjogJ2JlemllcicgICAgICAgICAgICAgICAgICAgLy8gb25lIG9mICdiZXppZXInLCAnbGluZWFyJywgb3IgJ3N0ZXAnCiAgICogICB0aW1lc3RhbXBGb3JtYXR0ZXI6IG51bGwsICAgICAgICAgICAgICAgICAvLyBvcHRpb25hbCBmdW5jdGlvbiB0byBmb3JtYXQgdGltZSBzdGFtcHMgZm9yIGJvdHRvbSBvZiBjaGFydAogICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLy8geW91IG1heSB1c2UgU21vb3RoaWVDaGFydC50aW1lRm9ybWF0dGVyLCBvciB5b3VyIG93bjogZnVuY3Rpb24oZGF0ZSkgeyByZXR1cm4gJyc7IH0KICAgKiAgIHNjcm9sbEJhY2t3YXJkczogZmFsc2UsICAgICAgICAgICAgICAgICAgIC8vIHJldmVyc2UgdGhlIHNjcm9sbCBkaXJlY3Rpb24gb2YgdGhlIGNoYXJ0CiAgICogICBob3Jpem9udGFsTGluZXM6IFtdLCAgICAgICAgICAgICAgICAgICAgICAvLyBbIHsgdmFsdWU6IDAsIGNvbG9yOiAnI2ZmZmZmZicsIGxpbmVXaWR0aDogMSB9IF0KICAgKiAgIGdyaWQ6CiAgICogICB7CiAgICogICAgIGZpbGxTdHlsZTogJyMwMDAwMDAnLCAgICAgICAgICAgICAgICAgICAvLyB0aGUgYmFja2dyb3VuZCBjb2xvdXIgb2YgdGhlIGNoYXJ0CiAgICogICAgIGxpbmVXaWR0aDogMSwgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyB0aGUgcGl4ZWwgd2lkdGggb2YgZ3JpZCBsaW5lcwogICAqICAgICBzdHJva2VTdHlsZTogJyM3Nzc3NzcnLCAgICAgICAgICAgICAgICAgLy8gY29sb3VyIG9mIGdyaWQgbGluZXMKICAgKiAgICAgbWlsbGlzUGVyTGluZTogMTAwMCwgICAgICAgICAgICAgICAgICAgIC8vIGRpc3RhbmNlIGJldHdlZW4gdmVydGljYWwgZ3JpZCBsaW5lcwogICAqICAgICBzaGFycExpbmVzOiBmYWxzZSwgICAgICAgICAgICAgICAgICAgICAgLy8gY29udHJvbHMgd2hldGhlciBncmlkIGxpbmVzIGFyZSAxcHggc2hhcnAsIG9yIHNvZnRlbmVkCiAgICogICAgIHZlcnRpY2FsU2VjdGlvbnM6IDIsICAgICAgICAgICAgICAgICAgICAvLyBudW1iZXIgb2YgdmVydGljYWwgc2VjdGlvbnMgbWFya2VkIG91dCBieSBob3Jpem9udGFsIGdyaWQgbGluZXMKICAgKiAgICAgYm9yZGVyVmlzaWJsZTogdHJ1ZSAgICAgICAgICAgICAgICAgICAgIC8vIHdoZXRoZXIgdGhlIGdyaWQgbGluZXMgdHJhY2UgdGhlIGJvcmRlciBvZiB0aGUgY2hhcnQgb3Igbm90CiAgICogICB9LAogICAqICAgbGFiZWxzCiAgICogICB7CiAgICogICAgIGRpc2FibGVkOiBmYWxzZSwgICAgICAgICAgICAgICAgICAgICAgICAvLyBlbmFibGVzL2Rpc2FibGVzIGxhYmVscyBzaG93aW5nIHRoZSBtaW4vbWF4IHZhbHVlcwogICAqICAgICBmaWxsU3R5bGU6ICcjZmZmZmZmJywgICAgICAgICAgICAgICAgICAgLy8gY29sb3VyIGZvciB0ZXh0IG9mIGxhYmVscywKICAgKiAgICAgZm9udFNpemU6IDE1LAogICAqICAgICBmb250RmFtaWx5OiAnc2Fucy1zZXJpZicsCiAgICogICAgIHByZWNpc2lvbjogMgogICAqICAgfSwKICAgKiAgIHRvb2x0aXA6IGZhbHNlICAgICAgICAgICAgICAgICAgICAgICAgICAgIC8vIHNob3cgdG9vbHRpcCB3aGVuIG1vdXNlIGlzIG92ZXIgdGhlIGNoYXJ0CiAgICogICB0b29sdGlwTGluZTogeyAgICAgICAgICAgICAgICAgICAgICAgICAgICAvLyBwcm9wZXJ0aWVzIGZvciBhIHZlcnRpY2FsIGxpbmUgYXQgdGhlIGN1cnNvciBwb3NpdGlvbgogICAqICAgICBsaW5lV2lkdGg6IDEsCiAgICogICAgIHN0cm9rZVN0eWxlOiAnI0JCQkJCQicKICAgKiAgIH0sCiAgICogICB0b29sdGlwRm9ybWF0dGVyOiBTbW9vdGhpZUNoYXJ0LnRvb2x0aXBGb3JtYXR0ZXIsIC8vIGZvcm1hdHRlciBmdW5jdGlvbiBmb3IgdG9vbHRpcCB0ZXh0CiAgICogICByZXNwb25zaXZlOiBmYWxzZSwgICAgICAgICAgICAgICAgICAgICAgICAvLyB3aGV0aGVyIHRoZSBjaGFydCBzaG91bGQgYWRhcHQgdG8gdGhlIHNpemUgb2YgdGhlIGNhbnZhcwogICAqICAgbGltaXRGUFM6IDAgICAgICAgICAgICAgICAgICAgICAgICAgLy8gbWF4aW11bSBmcmFtZSByYXRlIHRoZSBjaGFydCB3aWxsIHJlbmRlciBhdCwgaW4gRlBTICh6ZXJvIG1lYW5zIG5vIGxpbWl0KQogICAqIH0KICAgKiA8L3ByZT4KICAgKgogICAqIEBjb25zdHJ1Y3RvcgogICAqLwogIGZ1bmN0aW9uIFNtb290aGllQ2hhcnQob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gVXRpbC5leHRlbmQoe30sIFNtb290aGllQ2hhcnQuZGVmYXVsdENoYXJ0T3B0aW9ucywgb3B0aW9ucyk7CiAgICB0aGlzLnNlcmllc1NldCA9IFtdOwogICAgdGhpcy5jdXJyZW50VmFsdWVSYW5nZSA9IDE7CiAgICB0aGlzLmN1cnJlbnRWaXNNaW5WYWx1ZSA9IDA7CiAgICB0aGlzLmxhc3RSZW5kZXJUaW1lTWlsbGlzID0gMDsKCiAgICB0aGlzLm1vdXNlbW92ZSA9IHRoaXMubW91c2Vtb3ZlLmJpbmQodGhpcyk7CiAgICB0aGlzLm1vdXNlb3V0ID0gdGhpcy5tb3VzZW91dC5iaW5kKHRoaXMpOwogIH0KCiAgLyoqIEZvcm1hdHMgdGhlIEhUTUwgc3RyaW5nIGNvbnRlbnQgb2YgdGhlIHRvb2x0aXAuICovCiAgU21vb3RoaWVDaGFydC50b29sdGlwRm9ybWF0dGVyID0gZnVuY3Rpb24gKHRpbWVzdGFtcCwgZGF0YSkgewogICAgICB2YXIgdGltZXN0YW1wRm9ybWF0dGVyID0gdGhpcy5vcHRpb25zLnRpbWVzdGFtcEZvcm1hdHRlciB8fCBTbW9vdGhpZUNoYXJ0LnRpbWVGb3JtYXR0ZXIsCiAgICAgICAgICBsaW5lcyA9IFt0aW1lc3RhbXBGb3JtYXR0ZXIobmV3IERhdGUodGltZXN0YW1wKSldOwoKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhLmxlbmd0aDsgKytpKSB7CiAgICAgICAgbGluZXMucHVzaCgnPHNwYW4gc3R5bGU9ImNvbG9yOicgKyBkYXRhW2ldLnNlcmllcy5vcHRpb25zLnN0cm9rZVN0eWxlICsgJyI+JyArCiAgICAgICAgdGhpcy5vcHRpb25zLnlNYXhGb3JtYXR0ZXIoZGF0YVtpXS52YWx1ZSwgdGhpcy5vcHRpb25zLmxhYmVscy5wcmVjaXNpb24pICsgJzwvc3Bhbj4nKTsKICAgICAgfQoKICAgICAgcmV0dXJuIGxpbmVzLmpvaW4oJzxicj4nKTsKICB9OwoKICBTbW9vdGhpZUNoYXJ0LmRlZmF1bHRDaGFydE9wdGlvbnMgPSB7CiAgICBtaWxsaXNQZXJQaXhlbDogMjAsCiAgICBlbmFibGVEcGlTY2FsaW5nOiB0cnVlLAogICAgeU1pbkZvcm1hdHRlcjogZnVuY3Rpb24obWluLCBwcmVjaXNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQobWluKS50b0ZpeGVkKHByZWNpc2lvbik7CiAgICB9LAogICAgeU1heEZvcm1hdHRlcjogZnVuY3Rpb24obWF4LCBwcmVjaXNpb24pIHsKICAgICAgcmV0dXJuIHBhcnNlRmxvYXQobWF4KS50b0ZpeGVkKHByZWNpc2lvbik7CiAgICB9LAogICAgbWF4VmFsdWVTY2FsZTogMSwKICAgIG1pblZhbHVlU2NhbGU6IDEsCiAgICBpbnRlcnBvbGF0aW9uOiAnYmV6aWVyJywKICAgIHNjYWxlU21vb3RoaW5nOiAwLjEyNSwKICAgIG1heERhdGFTZXRMZW5ndGg6IDIsCiAgICBzY3JvbGxCYWNrd2FyZHM6IGZhbHNlLAogICAgZ3JpZDogewogICAgICBmaWxsU3R5bGU6ICcjMDAwMDAwJywKICAgICAgc3Ryb2tlU3R5bGU6ICcjNzc3Nzc3JywKICAgICAgbGluZVdpZHRoOiAxLAogICAgICBzaGFycExpbmVzOiBmYWxzZSwKICAgICAgbWlsbGlzUGVyTGluZTogMTAwMCwKICAgICAgdmVydGljYWxTZWN0aW9uczogMiwKICAgICAgYm9yZGVyVmlzaWJsZTogdHJ1ZQogICAgfSwKICAgIGxhYmVsczogewogICAgICBmaWxsU3R5bGU6ICcjZmZmZmZmJywKICAgICAgZGlzYWJsZWQ6IGZhbHNlLAogICAgICBmb250U2l6ZTogMTAsCiAgICAgIGZvbnRGYW1pbHk6ICdtb25vc3BhY2UnLAogICAgICBwcmVjaXNpb246IDIKICAgIH0sCiAgICBob3Jpem9udGFsTGluZXM6IFtdLAogICAgdG9vbHRpcDogZmFsc2UsCiAgICB0b29sdGlwTGluZTogewogICAgICBsaW5lV2lkdGg6IDEsCiAgICAgIHN0cm9rZVN0eWxlOiAnI0JCQkJCQicKICAgIH0sCiAgICB0b29sdGlwRm9ybWF0dGVyOiBTbW9vdGhpZUNoYXJ0LnRvb2x0aXBGb3JtYXR0ZXIsCiAgICByZXNwb25zaXZlOiBmYWxzZSwKICAgIGxpbWl0RlBTOiAwCiAgfTsKCiAgLy8gQmFzZWQgb24gaHR0cDovL2luc3Bpcml0LmdpdGh1Yi5jb20vanNmZWF0L2pzL2NvbXBhdGliaWxpdHkuanMKICBTbW9vdGhpZUNoYXJ0LkFuaW1hdGVDb21wYXRpYmlsaXR5ID0gKGZ1bmN0aW9uKCkgewogICAgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKGNhbGxiYWNrLCBlbGVtZW50KSB7CiAgICAgICAgICB2YXIgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0KICAgICAgICAgICAgd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSAgICAgICAgfHwKICAgICAgICAgICAgd2luZG93LndlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSAgfHwKICAgICAgICAgICAgd2luZG93Lm1velJlcXVlc3RBbmltYXRpb25GcmFtZSAgICAgfHwKICAgICAgICAgICAgd2luZG93Lm9SZXF1ZXN0QW5pbWF0aW9uRnJhbWUgICAgICAgfHwKICAgICAgICAgICAgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lICAgICAgfHwKICAgICAgICAgICAgZnVuY3Rpb24oY2FsbGJhY2spIHsKICAgICAgICAgICAgICByZXR1cm4gd2luZG93LnNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFjayhEYXRlLm5vdygpKTsKICAgICAgICAgICAgICB9LCAxNik7CiAgICAgICAgICAgIH07CiAgICAgICAgICByZXR1cm4gcmVxdWVzdEFuaW1hdGlvbkZyYW1lLmNhbGwod2luZG93LCBjYWxsYmFjaywgZWxlbWVudCk7CiAgICAgICAgfSwKICAgICAgICBjYW5jZWxBbmltYXRpb25GcmFtZSA9IGZ1bmN0aW9uKGlkKSB7CiAgICAgICAgICB2YXIgY2FuY2VsQW5pbWF0aW9uRnJhbWUgPQogICAgICAgICAgICB3aW5kb3cuY2FuY2VsQW5pbWF0aW9uRnJhbWUgfHwKICAgICAgICAgICAgZnVuY3Rpb24oaWQpIHsKICAgICAgICAgICAgICBjbGVhclRpbWVvdXQoaWQpOwogICAgICAgICAgICB9OwogICAgICAgICAgcmV0dXJuIGNhbmNlbEFuaW1hdGlvbkZyYW1lLmNhbGwod2luZG93LCBpZCk7CiAgICAgICAgfTsKCiAgICByZXR1cm4gewogICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWU6IHJlcXVlc3RBbmltYXRpb25GcmFtZSwKICAgICAgY2FuY2VsQW5pbWF0aW9uRnJhbWU6IGNhbmNlbEFuaW1hdGlvbkZyYW1lCiAgICB9OwogIH0pKCk7CgogIFNtb290aGllQ2hhcnQuZGVmYXVsdFNlcmllc1ByZXNlbnRhdGlvbk9wdGlvbnMgPSB7CiAgICBsaW5lV2lkdGg6IDEsCiAgICBzdHJva2VTdHlsZTogJyNmZmZmZmYnCiAgfTsKCiAgLyoqCiAgICogQWRkcyBhIDxjb2RlPlRpbWVTZXJpZXM8L2NvZGU+IHRvIHRoaXMgY2hhcnQsIHdpdGggb3B0aW9uYWwgcHJlc2VudGF0aW9uIG9wdGlvbnMuCiAgICoKICAgKiBQcmVzZW50YXRpb24gb3B0aW9ucyBzaG91bGQgYmUgb2YgdGhlIGZvcm0gKGRlZmF1bHRzIHNob3duKToKICAgKgogICAqIDxwcmU+CiAgICogewogICAqICAgbGluZVdpZHRoOiAxLAogICAqICAgc3Ryb2tlU3R5bGU6ICcjZmZmZmZmJywKICAgKiAgIGZpbGxTdHlsZTogdW5kZWZpbmVkCiAgICogfQogICAqIDwvcHJlPgogICAqLwogIFNtb290aGllQ2hhcnQucHJvdG90eXBlLmFkZFRpbWVTZXJpZXMgPSBmdW5jdGlvbih0aW1lU2VyaWVzLCBvcHRpb25zKSB7CiAgICB0aGlzLnNlcmllc1NldC5wdXNoKHt0aW1lU2VyaWVzOiB0aW1lU2VyaWVzLCBvcHRpb25zOiBVdGlsLmV4dGVuZCh7fSwgU21vb3RoaWVDaGFydC5kZWZhdWx0U2VyaWVzUHJlc2VudGF0aW9uT3B0aW9ucywgb3B0aW9ucyl9KTsKICAgIGlmICh0aW1lU2VyaWVzLm9wdGlvbnMucmVzZXRCb3VuZHMgJiYgdGltZVNlcmllcy5vcHRpb25zLnJlc2V0Qm91bmRzSW50ZXJ2YWwgPiAwKSB7CiAgICAgIHRpbWVTZXJpZXMucmVzZXRCb3VuZHNUaW1lcklkID0gc2V0SW50ZXJ2YWwoCiAgICAgICAgZnVuY3Rpb24oKSB7CiAgICAgICAgICB0aW1lU2VyaWVzLnJlc2V0Qm91bmRzKCk7CiAgICAgICAgfSwKICAgICAgICB0aW1lU2VyaWVzLm9wdGlvbnMucmVzZXRCb3VuZHNJbnRlcnZhbAogICAgICApOwogICAgfQogIH07CgogIC8qKgogICAqIFJlbW92ZXMgdGhlIHNwZWNpZmllZCA8Y29kZT5UaW1lU2VyaWVzPC9jb2RlPiBmcm9tIHRoZSBjaGFydC4KICAgKi8KICBTbW9vdGhpZUNoYXJ0LnByb3RvdHlwZS5yZW1vdmVUaW1lU2VyaWVzID0gZnVuY3Rpb24odGltZVNlcmllcykgewogICAgLy8gRmluZCB0aGUgY29ycmVjdCB0aW1lc2VyaWVzIHRvIHJlbW92ZSwgYW5kIHJlbW92ZSBpdAogICAgdmFyIG51bVNlcmllcyA9IHRoaXMuc2VyaWVzU2V0Lmxlbmd0aDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtU2VyaWVzOyBpKyspIHsKICAgICAgaWYgKHRoaXMuc2VyaWVzU2V0W2ldLnRpbWVTZXJpZXMgPT09IHRpbWVTZXJpZXMpIHsKICAgICAgICB0aGlzLnNlcmllc1NldC5zcGxpY2UoaSwgMSk7CiAgICAgICAgYnJlYWs7CiAgICAgIH0KICAgIH0KICAgIC8vIElmIGEgdGltZXIgd2FzIG9wZXJhdGluZyBmb3IgdGhhdCB0aW1lc2VyaWVzLCByZW1vdmUgaXQKICAgIGlmICh0aW1lU2VyaWVzLnJlc2V0Qm91bmRzVGltZXJJZCkgewogICAgICAvLyBTdG9wIHJlc2V0dGluZyB0aGUgYm91bmRzLCBpZiB3ZSB3ZXJlCiAgICAgIGNsZWFySW50ZXJ2YWwodGltZVNlcmllcy5yZXNldEJvdW5kc1RpbWVySWQpOwogICAgfQogIH07CgogIC8qKgogICAqIEdldHMgcmVuZGVyIG9wdGlvbnMgZm9yIHRoZSBzcGVjaWZpZWQgPGNvZGU+VGltZVNlcmllczwvY29kZT4uCiAgICoKICAgKiBBcyB5b3UgbWF5IHVzZSBhIHNpbmdsZSA8Y29kZT5UaW1lU2VyaWVzPC9jb2RlPiBpbiBtdWx0aXBsZSBjaGFydHMgd2l0aCBkaWZmZXJlbnQgZm9ybWF0dGluZyBpbiBlYWNoIHVzYWdlLAogICAqIHRoZXNlIHNldHRpbmdzIGFyZSBzdG9yZWQgaW4gdGhlIGNoYXJ0LgogICAqLwogIFNtb290aGllQ2hhcnQucHJvdG90eXBlLmdldFRpbWVTZXJpZXNPcHRpb25zID0gZnVuY3Rpb24odGltZVNlcmllcykgewogICAgLy8gRmluZCB0aGUgY29ycmVjdCB0aW1lc2VyaWVzIHRvIHJlbW92ZSwgYW5kIHJlbW92ZSBpdAogICAgdmFyIG51bVNlcmllcyA9IHRoaXMuc2VyaWVzU2V0Lmxlbmd0aDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtU2VyaWVzOyBpKyspIHsKICAgICAgaWYgKHRoaXMuc2VyaWVzU2V0W2ldLnRpbWVTZXJpZXMgPT09IHRpbWVTZXJpZXMpIHsKICAgICAgICByZXR1cm4gdGhpcy5zZXJpZXNTZXRbaV0ub3B0aW9uczsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIEJyaW5ncyB0aGUgc3BlY2lmaWVkIDxjb2RlPlRpbWVTZXJpZXM8L2NvZGU+IHRvIHRoZSB0b3Agb2YgdGhlIGNoYXJ0LiBJdCB3aWxsIGJlIHJlbmRlcmVkIGxhc3QuCiAgICovCiAgU21vb3RoaWVDaGFydC5wcm90b3R5cGUuYnJpbmdUb0Zyb250ID0gZnVuY3Rpb24odGltZVNlcmllcykgewogICAgLy8gRmluZCB0aGUgY29ycmVjdCB0aW1lc2VyaWVzIHRvIHJlbW92ZSwgYW5kIHJlbW92ZSBpdAogICAgdmFyIG51bVNlcmllcyA9IHRoaXMuc2VyaWVzU2V0Lmxlbmd0aDsKICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbnVtU2VyaWVzOyBpKyspIHsKICAgICAgaWYgKHRoaXMuc2VyaWVzU2V0W2ldLnRpbWVTZXJpZXMgPT09IHRpbWVTZXJpZXMpIHsKICAgICAgICB2YXIgc2V0ID0gdGhpcy5zZXJpZXNTZXQuc3BsaWNlKGksIDEpOwogICAgICAgIHRoaXMuc2VyaWVzU2V0LnB1c2goc2V0WzBdKTsKICAgICAgICBicmVhazsKICAgICAgfQogICAgfQogIH07CgogIC8qKgogICAqIEluc3RydWN0cyB0aGUgPGNvZGU+U21vb3RoaWVDaGFydDwvY29kZT4gdG8gc3RhcnQgcmVuZGVyaW5nIHRvIHRoZSBwcm92aWRlZCBjYW52YXMsIHdpdGggc3BlY2lmaWVkIGRlbGF5LgogICAqCiAgICogQHBhcmFtIGNhbnZhcyB0aGUgdGFyZ2V0IGNhbnZhcyBlbGVtZW50CiAgICogQHBhcmFtIGRlbGF5TWlsbGlzIGFuIGFtb3VudCBvZiB0aW1lIHRvIHdhaXQgYmVmb3JlIGEgZGF0YSBwb2ludCBpcyBzaG93bi4gVGhpcyBjYW4gcHJldmVudCB0aGUgZW5kIG9mIHRoZSBzZXJpZXMKICAgKiBmcm9tIGFwcGVhcmluZyBvbiBzY3JlZW4sIHdpdGggbmV3IHZhbHVlcyBmbGFzaGluZyBpbnRvIHZpZXcsIGF0IHRoZSBleHBlbnNlIG9mIHNvbWUgbGF0ZW5jeS4KICAgKi8KICBTbW9vdGhpZUNoYXJ0LnByb3RvdHlwZS5zdHJlYW1UbyA9IGZ1bmN0aW9uKGNhbnZhcywgZGVsYXlNaWxsaXMpIHsKICAgIHRoaXMuY2FudmFzID0gY2FudmFzOwogICAgdGhpcy5kZWxheSA9IGRlbGF5TWlsbGlzOwogICAgdGhpcy5zdGFydCgpOwogIH07CgogIFNtb290aGllQ2hhcnQucHJvdG90eXBlLmdldFRvb2x0aXBFbCA9IGZ1bmN0aW9uICgpIHsKICAgIC8vIENyZWF0ZSB0aGUgdG9vbCB0aXAgZWxlbWVudCBsYXppbHkKICAgIGlmICghdGhpcy50b29sdGlwRWwpIHsKICAgICAgdGhpcy50b29sdGlwRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgdGhpcy50b29sdGlwRWwuY2xhc3NOYW1lID0gJ3Ntb290aGllLWNoYXJ0LXRvb2x0aXAnOwogICAgICB0aGlzLnRvb2x0aXBFbC5zdHlsZS5wb3NpdGlvbiA9ICdhYnNvbHV0ZSc7CiAgICAgIHRoaXMudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy50b29sdGlwRWwpOwogICAgfQogICAgcmV0dXJuIHRoaXMudG9vbHRpcEVsOwogIH07CgogIFNtb290aGllQ2hhcnQucHJvdG90eXBlLnVwZGF0ZVRvb2x0aXAgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZWwgPSB0aGlzLmdldFRvb2x0aXBFbCgpOwoKICAgIGlmICghdGhpcy5tb3VzZW92ZXIgfHwgIXRoaXMub3B0aW9ucy50b29sdGlwKSB7CiAgICAgIGVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgICAgIHJldHVybjsKICAgIH0KCiAgICB2YXIgdGltZSA9IHRoaXMubGFzdFJlbmRlclRpbWVNaWxsaXMgLSAodGhpcy5kZWxheSB8fCAwKTsKCiAgICAvLyBSb3VuZCB0aW1lIGRvd24gdG8gcGl4ZWwgZ3JhbnVsYXJpdHksIHNvIG1vdGlvbiBhcHBlYXJzIHNtb290aGVyLgogICAgdGltZSAtPSB0aW1lICUgdGhpcy5vcHRpb25zLm1pbGxpc1BlclBpeGVsOwoKICAgIC8vIHggcGl4ZWwgdG8gdGltZQogICAgdmFyIHQgPSB0aGlzLm9wdGlvbnMuc2Nyb2xsQmFja3dhcmRzCiAgICAgID8gdGltZSAtIHRoaXMubW91c2VYICogdGhpcy5vcHRpb25zLm1pbGxpc1BlclBpeGVsCiAgICAgIDogdGltZSAtICh0aGlzLmNhbnZhcy5vZmZzZXRXaWR0aCAtIHRoaXMubW91c2VYKSAqIHRoaXMub3B0aW9ucy5taWxsaXNQZXJQaXhlbDsKCiAgICB2YXIgZGF0YSA9IFtdOwoKICAgICAvLyBGb3IgZWFjaCBkYXRhIHNldC4uLgogICAgZm9yICh2YXIgZCA9IDA7IGQgPCB0aGlzLnNlcmllc1NldC5sZW5ndGg7IGQrKykgewogICAgICB2YXIgdGltZVNlcmllcyA9IHRoaXMuc2VyaWVzU2V0W2RdLnRpbWVTZXJpZXMsCiAgICAgICAgICAvLyBmaW5kIGRhdGFwb2ludCBjbG9zZXN0IHRvIHRpbWUgJ3QnCiAgICAgICAgICBjbG9zZUlkeCA9IFV0aWwuYmluYXJ5U2VhcmNoKHRpbWVTZXJpZXMuZGF0YSwgdCk7CgogICAgICBpZiAoY2xvc2VJZHggPiAwICYmIGNsb3NlSWR4IDwgdGltZVNlcmllcy5kYXRhLmxlbmd0aCkgewogICAgICAgIGRhdGEucHVzaCh7IHNlcmllczogdGhpcy5zZXJpZXNTZXRbZF0sIGluZGV4OiBjbG9zZUlkeCwgdmFsdWU6IHRpbWVTZXJpZXMuZGF0YVtjbG9zZUlkeF1bMV0gfSk7CiAgICAgIH0KICAgIH0KCiAgICBpZiAoZGF0YS5sZW5ndGgpIHsKICAgICAgZWwuaW5uZXJIVE1MID0gdGhpcy5vcHRpb25zLnRvb2x0aXBGb3JtYXR0ZXIuY2FsbCh0aGlzLCB0LCBkYXRhKTsKICAgICAgZWwuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICB9IGVsc2UgewogICAgICBlbC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgfQogIH07CgogIFNtb290aGllQ2hhcnQucHJvdG90eXBlLm1vdXNlbW92ZSA9IGZ1bmN0aW9uIChldnQpIHsKICAgIHRoaXMubW91c2VvdmVyID0gdHJ1ZTsKICAgIHRoaXMubW91c2VYID0gZXZ0Lm9mZnNldFg7CiAgICB0aGlzLm1vdXNlWSA9IGV2dC5vZmZzZXRZOwogICAgdGhpcy5tb3VzZVBhZ2VYID0gZXZ0LnBhZ2VYOwogICAgdGhpcy5tb3VzZVBhZ2VZID0gZXZ0LnBhZ2VZOwoKICAgIHZhciBlbCA9IHRoaXMuZ2V0VG9vbHRpcEVsKCk7CiAgICBlbC5zdHlsZS50b3AgPSBNYXRoLnJvdW5kKHRoaXMubW91c2VQYWdlWSkgKyAncHgnOwogICAgZWwuc3R5bGUubGVmdCA9IE1hdGgucm91bmQodGhpcy5tb3VzZVBhZ2VYKSArICdweCc7CiAgICB0aGlzLnVwZGF0ZVRvb2x0aXAoKTsKICB9OwoKICBTbW9vdGhpZUNoYXJ0LnByb3RvdHlwZS5tb3VzZW91dCA9IGZ1bmN0aW9uICgpIHsKICAgIHRoaXMubW91c2VvdmVyID0gZmFsc2U7CiAgICB0aGlzLm1vdXNlWCA9IHRoaXMubW91c2VZID0gLTE7CiAgICBpZiAoU21vb3RoaWVDaGFydC50b29sdGlwRWwpCiAgICAgIFNtb290aGllQ2hhcnQudG9vbHRpcEVsLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7CiAgfTsKCiAgLyoqCiAgICogTWFrZSBzdXJlIHRoZSBjYW52YXMgaGFzIHRoZSBvcHRpbWFsIHJlc29sdXRpb24gZm9yIHRoZSBkZXZpY2UncyBwaXhlbCByYXRpby4KICAgKi8KICBTbW9vdGhpZUNoYXJ0LnByb3RvdHlwZS5yZXNpemUgPSBmdW5jdGlvbiAoKSB7CiAgICB2YXIgZHByID0gIXRoaXMub3B0aW9ucy5lbmFibGVEcGlTY2FsaW5nIHx8ICF3aW5kb3cgPyAxIDogd2luZG93LmRldmljZVBpeGVsUmF0aW8sCiAgICAgICAgd2lkdGgsIGhlaWdodDsKICAgIGlmICh0aGlzLm9wdGlvbnMucmVzcG9uc2l2ZSkgewogICAgICAvLyBOZXdlciBiZWhhdmlvdXI6IFVzZSB0aGUgY2FudmFzJ3Mgc2l6ZSBpbiB0aGUgbGF5b3V0LCBhbmQgc2V0IHRoZSBpbnRlcm5hbAogICAgICAvLyByZXNvbHV0aW9uIGFjY29yZGluZyB0byB0aGF0IHNpemUgYW5kIHRoZSBkZXZpY2UgcGl4ZWwgcmF0aW8gKGVnOiBoaWdoIERQSSkKICAgICAgd2lkdGggPSB0aGlzLmNhbnZhcy5vZmZzZXRXaWR0aDsKICAgICAgaGVpZ2h0ID0gdGhpcy5jYW52YXMub2Zmc2V0SGVpZ2h0OwoKICAgICAgaWYgKHdpZHRoICE9PSB0aGlzLmxhc3RXaWR0aCkgewogICAgICAgIHRoaXMubGFzdFdpZHRoID0gd2lkdGg7CiAgICAgICAgdGhpcy5jYW52YXMuc2V0QXR0cmlidXRlKCd3aWR0aCcsIChNYXRoLmZsb29yKHdpZHRoICogZHByKSkudG9TdHJpbmcoKSk7CiAgICAgIH0KICAgICAgaWYgKGhlaWdodCAhPT0gdGhpcy5sYXN0SGVpZ2h0KSB7CiAgICAgICAgdGhpcy5sYXN0SGVpZ2h0ID0gaGVpZ2h0OwogICAgICAgIHRoaXMuY2FudmFzLnNldEF0dHJpYnV0ZSgnaGVpZ2h0JywgKE1hdGguZmxvb3IoaGVpZ2h0ICogZHByKSkudG9TdHJpbmcoKSk7CiAgICAgIH0KICAgIH0gZWxzZSBpZiAoZHByICE9PSAxKSB7CiAgICAgIC8vIE9sZGVyIGJlaGF2aW91cjogdXNlIHRoZSBjYW52YXMncyBpbm5lciBkaW1lbnNpb25zIGFuZCBzY2FsZSB0aGUgZWxlbWVudCdzIHNpemUKICAgICAgLy8gYWNjb3JkaW5nIHRvIHRoYXQgc2l6ZSBhbmQgdGhlIGRldmljZSBwaXhlbCByYXRpbyAoZWc6IGhpZ2ggRFBJKQogICAgICB3aWR0aCA9IHBhcnNlSW50KHRoaXMuY2FudmFzLmdldEF0dHJpYnV0ZSgnd2lkdGgnKSk7CiAgICAgIGhlaWdodCA9IHBhcnNlSW50KHRoaXMuY2FudmFzLmdldEF0dHJpYnV0ZSgnaGVpZ2h0JykpOwoKICAgICAgaWYgKCF0aGlzLm9yaWdpbmFsV2lkdGggfHwgKE1hdGguZmxvb3IodGhpcy5vcmlnaW5hbFdpZHRoICogZHByKSAhPT0gd2lkdGgpKSB7CiAgICAgICAgdGhpcy5vcmlnaW5hbFdpZHRoID0gd2lkdGg7CiAgICAgICAgdGhpcy5jYW52YXMuc2V0QXR0cmlidXRlKCd3aWR0aCcsIChNYXRoLmZsb29yKHdpZHRoICogZHByKSkudG9TdHJpbmcoKSk7CiAgICAgICAgdGhpcy5jYW52YXMuc3R5bGUud2lkdGggPSB3aWR0aCArICdweCc7CiAgICAgICAgdGhpcy5jYW52YXMuZ2V0Q29udGV4dCgnMmQnKS5zY2FsZShkcHIsIGRwcik7CiAgICAgIH0KCiAgICAgIGlmICghdGhpcy5vcmlnaW5hbEhlaWdodCB8fCAoTWF0aC5mbG9vcih0aGlzLm9yaWdpbmFsSGVpZ2h0ICogZHByKSAhPT0gaGVpZ2h0KSkgewogICAgICAgIHRoaXMub3JpZ2luYWxIZWlnaHQgPSBoZWlnaHQ7CiAgICAgICAgdGhpcy5jYW52YXMuc2V0QXR0cmlidXRlKCdoZWlnaHQnLCAoTWF0aC5mbG9vcihoZWlnaHQgKiBkcHIpKS50b1N0cmluZygpKTsKICAgICAgICB0aGlzLmNhbnZhcy5zdHlsZS5oZWlnaHQgPSBoZWlnaHQgKyAncHgnOwogICAgICAgIHRoaXMuY2FudmFzLmdldENvbnRleHQoJzJkJykuc2NhbGUoZHByLCBkcHIpOwogICAgICB9CiAgICB9CiAgfTsKCiAgLyoqCiAgICogU3RhcnRzIHRoZSBhbmltYXRpb24gb2YgdGhpcyBjaGFydC4KICAgKi8KICBTbW9vdGhpZUNoYXJ0LnByb3RvdHlwZS5zdGFydCA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuZnJhbWUpIHsKICAgICAgLy8gV2UncmUgYWxyZWFkeSBydW5uaW5nLCBzbyBqdXN0IHJldHVybgogICAgICByZXR1cm47CiAgICB9CgogICAgdGhpcy5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5tb3VzZW1vdmUpOwogICAgdGhpcy5jYW52YXMuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VvdXQnLCB0aGlzLm1vdXNlb3V0KTsKCiAgICAvLyBSZW5kZXJzIGEgZnJhbWUsIGFuZCBxdWV1ZXMgdGhlIG5leHQgZnJhbWUgZm9yIGxhdGVyIHJlbmRlcmluZwogICAgdmFyIGFuaW1hdGUgPSBmdW5jdGlvbigpIHsKICAgICAgdGhpcy5mcmFtZSA9IFNtb290aGllQ2hhcnQuQW5pbWF0ZUNvbXBhdGliaWxpdHkucmVxdWVzdEFuaW1hdGlvbkZyYW1lKGZ1bmN0aW9uKCkgewogICAgICAgIHRoaXMucmVuZGVyKCk7CiAgICAgICAgYW5pbWF0ZSgpOwogICAgICB9LmJpbmQodGhpcykpOwogICAgfS5iaW5kKHRoaXMpOwoKICAgIGFuaW1hdGUoKTsKICB9OwoKICAvKioKICAgKiBTdG9wcyB0aGUgYW5pbWF0aW9uIG9mIHRoaXMgY2hhcnQuCiAgICovCiAgU21vb3RoaWVDaGFydC5wcm90b3R5cGUuc3RvcCA9IGZ1bmN0aW9uKCkgewogICAgaWYgKHRoaXMuZnJhbWUpIHsKICAgICAgU21vb3RoaWVDaGFydC5BbmltYXRlQ29tcGF0aWJpbGl0eS5jYW5jZWxBbmltYXRpb25GcmFtZSh0aGlzLmZyYW1lKTsKICAgICAgZGVsZXRlIHRoaXMuZnJhbWU7CiAgICAgIHRoaXMuY2FudmFzLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMubW91c2Vtb3ZlKTsKICAgICAgdGhpcy5jYW52YXMucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2VvdXQnLCB0aGlzLm1vdXNlb3V0KTsKICAgIH0KICB9OwoKICBTbW9vdGhpZUNoYXJ0LnByb3RvdHlwZS51cGRhdGVWYWx1ZVJhbmdlID0gZnVuY3Rpb24oKSB7CiAgICAvLyBDYWxjdWxhdGUgdGhlIGN1cnJlbnQgc2NhbGUgb2YgdGhlIGNoYXJ0LCBmcm9tIGFsbCB0aW1lIHNlcmllcy4KICAgIHZhciBjaGFydE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCiAgICAgICAgY2hhcnRNYXhWYWx1ZSA9IE51bWJlci5OYU4sCiAgICAgICAgY2hhcnRNaW5WYWx1ZSA9IE51bWJlci5OYU47CgogICAgZm9yICh2YXIgZCA9IDA7IGQgPCB0aGlzLnNlcmllc1NldC5sZW5ndGg7IGQrKykgewogICAgICAvLyBUT0RPKG5kdW5uKTogV2UgY291bGQgY2FsY3VsYXRlIC8gdHJhY2sgdGhlc2UgdmFsdWVzIGFzIHRoZXkgc3RyZWFtIGluLgogICAgICB2YXIgdGltZVNlcmllcyA9IHRoaXMuc2VyaWVzU2V0W2RdLnRpbWVTZXJpZXM7CiAgICAgIGlmICghaXNOYU4odGltZVNlcmllcy5tYXhWYWx1ZSkpIHsKICAgICAgICBjaGFydE1heFZhbHVlID0gIWlzTmFOKGNoYXJ0TWF4VmFsdWUpID8gTWF0aC5tYXgoY2hhcnRNYXhWYWx1ZSwgdGltZVNlcmllcy5tYXhWYWx1ZSkgOiB0aW1lU2VyaWVzLm1heFZhbHVlOwogICAgICB9CgogICAgICBpZiAoIWlzTmFOKHRpbWVTZXJpZXMubWluVmFsdWUpKSB7CiAgICAgICAgY2hhcnRNaW5WYWx1ZSA9ICFpc05hTihjaGFydE1pblZhbHVlKSA/IE1hdGgubWluKGNoYXJ0TWluVmFsdWUsIHRpbWVTZXJpZXMubWluVmFsdWUpIDogdGltZVNlcmllcy5taW5WYWx1ZTsKICAgICAgfQogICAgfQoKICAgIC8vIFNjYWxlIHRoZSBjaGFydE1heFZhbHVlIHRvIGFkZCBwYWRkaW5nIGF0IHRoZSB0b3AgaWYgcmVxdWlyZWQKICAgIGlmIChjaGFydE9wdGlvbnMubWF4VmFsdWUgIT0gbnVsbCkgewogICAgICBjaGFydE1heFZhbHVlID0gY2hhcnRPcHRpb25zLm1heFZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgY2hhcnRNYXhWYWx1ZSAqPSBjaGFydE9wdGlvbnMubWF4VmFsdWVTY2FsZTsKICAgIH0KCiAgICAvLyBTZXQgdGhlIG1pbmltdW0gaWYgd2UndmUgc3BlY2lmaWVkIG9uZQogICAgaWYgKGNoYXJ0T3B0aW9ucy5taW5WYWx1ZSAhPSBudWxsKSB7CiAgICAgIGNoYXJ0TWluVmFsdWUgPSBjaGFydE9wdGlvbnMubWluVmFsdWU7CiAgICB9IGVsc2UgewogICAgICBjaGFydE1pblZhbHVlIC09IE1hdGguYWJzKGNoYXJ0TWluVmFsdWUgKiBjaGFydE9wdGlvbnMubWluVmFsdWVTY2FsZSAtIGNoYXJ0TWluVmFsdWUpOwogICAgfQoKICAgIC8vIElmIGEgY3VzdG9tIHJhbmdlIGZ1bmN0aW9uIGlzIHNldCwgY2FsbCBpdAogICAgaWYgKHRoaXMub3B0aW9ucy55UmFuZ2VGdW5jdGlvbikgewogICAgICB2YXIgcmFuZ2UgPSB0aGlzLm9wdGlvbnMueVJhbmdlRnVuY3Rpb24oe21pbjogY2hhcnRNaW5WYWx1ZSwgbWF4OiBjaGFydE1heFZhbHVlfSk7CiAgICAgIGNoYXJ0TWluVmFsdWUgPSByYW5nZS5taW47CiAgICAgIGNoYXJ0TWF4VmFsdWUgPSByYW5nZS5tYXg7CiAgICB9CgogICAgaWYgKCFpc05hTihjaGFydE1heFZhbHVlKSAmJiAhaXNOYU4oY2hhcnRNaW5WYWx1ZSkpIHsKICAgICAgdmFyIHRhcmdldFZhbHVlUmFuZ2UgPSBjaGFydE1heFZhbHVlIC0gY2hhcnRNaW5WYWx1ZTsKICAgICAgdmFyIHZhbHVlUmFuZ2VEaWZmID0gKHRhcmdldFZhbHVlUmFuZ2UgLSB0aGlzLmN1cnJlbnRWYWx1ZVJhbmdlKTsKICAgICAgdmFyIG1pblZhbHVlRGlmZiA9IChjaGFydE1pblZhbHVlIC0gdGhpcy5jdXJyZW50VmlzTWluVmFsdWUpOwogICAgICB0aGlzLmlzQW5pbWF0aW5nU2NhbGUgPSBNYXRoLmFicyh2YWx1ZVJhbmdlRGlmZikgPiAwLjEgfHwgTWF0aC5hYnMobWluVmFsdWVEaWZmKSA+IDAuMTsKICAgICAgdGhpcy5jdXJyZW50VmFsdWVSYW5nZSArPSBjaGFydE9wdGlvbnMuc2NhbGVTbW9vdGhpbmcgKiB2YWx1ZVJhbmdlRGlmZjsKICAgICAgdGhpcy5jdXJyZW50VmlzTWluVmFsdWUgKz0gY2hhcnRPcHRpb25zLnNjYWxlU21vb3RoaW5nICogbWluVmFsdWVEaWZmOwogICAgfQoKICAgIHRoaXMudmFsdWVSYW5nZSA9IHsgbWluOiBjaGFydE1pblZhbHVlLCBtYXg6IGNoYXJ0TWF4VmFsdWUgfTsKICB9OwoKICBTbW9vdGhpZUNoYXJ0LnByb3RvdHlwZS5yZW5kZXIgPSBmdW5jdGlvbihjYW52YXMsIHRpbWUpIHsKICAgIHZhciBub3dNaWxsaXMgPSBEYXRlLm5vdygpOwoKICAgIC8vIFJlc3BlY3QgYW55IGZyYW1lIHJhdGUgbGltaXQuCiAgICBpZiAodGhpcy5vcHRpb25zLmxpbWl0RlBTID4gMCAmJiBub3dNaWxsaXMgLSB0aGlzLmxhc3RSZW5kZXJUaW1lTWlsbGlzIDwgKDEwMDAvdGhpcy5vcHRpb25zLmxpbWl0RlBTKSkKICAgICAgcmV0dXJuOwoKICAgIGlmICghdGhpcy5pc0FuaW1hdGluZ1NjYWxlKSB7CiAgICAgIC8vIFdlJ3JlIG5vdCBhbmltYXRpbmcuIFdlIGNhbiB1c2UgdGhlIGxhc3QgcmVuZGVyIHRpbWUgYW5kIHRoZSBzY3JvbGwgc3BlZWQgdG8gd29yayBvdXQgd2hldGhlcgogICAgICAvLyB3ZSBhY3R1YWxseSBuZWVkIHRvIHBhaW50IGFueXRoaW5nIHlldC4gSWYgbm90LCB3ZSBjYW4gcmV0dXJuIGltbWVkaWF0ZWx5LgoKICAgICAgLy8gUmVuZGVyIGF0IGxlYXN0IGV2ZXJ5IDEvNnRoIG9mIGEgc2Vjb25kLiBUaGUgY2FudmFzIG1heSBiZSByZXNpemVkLCB3aGljaCB0aGVyZSBpcwogICAgICAvLyBubyByZWxpYWJsZSB3YXkgdG8gZGV0ZWN0LgogICAgICB2YXIgbWF4SWRsZU1pbGxpcyA9IE1hdGgubWluKDEwMDAvNiwgdGhpcy5vcHRpb25zLm1pbGxpc1BlclBpeGVsKTsKCiAgICAgIGlmIChub3dNaWxsaXMgLSB0aGlzLmxhc3RSZW5kZXJUaW1lTWlsbGlzIDwgbWF4SWRsZU1pbGxpcykgewogICAgICAgIHJldHVybjsKICAgICAgfQogICAgfQoKICAgIHRoaXMucmVzaXplKCk7CiAgICB0aGlzLnVwZGF0ZVRvb2x0aXAoKTsKCiAgICB0aGlzLmxhc3RSZW5kZXJUaW1lTWlsbGlzID0gbm93TWlsbGlzOwoKICAgIGNhbnZhcyA9IGNhbnZhcyB8fCB0aGlzLmNhbnZhczsKICAgIHRpbWUgPSB0aW1lIHx8IG5vd01pbGxpcyAtICh0aGlzLmRlbGF5IHx8IDApOwoKICAgIC8vIFJvdW5kIHRpbWUgZG93biB0byBwaXhlbCBncmFudWxhcml0eSwgc28gbW90aW9uIGFwcGVhcnMgc21vb3RoZXIuCiAgICB0aW1lIC09IHRpbWUgJSB0aGlzLm9wdGlvbnMubWlsbGlzUGVyUGl4ZWw7CgogICAgdmFyIGNvbnRleHQgPSBjYW52YXMuZ2V0Q29udGV4dCgnMmQnKSwKICAgICAgICBjaGFydE9wdGlvbnMgPSB0aGlzLm9wdGlvbnMsCiAgICAgICAgZGltZW5zaW9ucyA9IHsgdG9wOiAwLCBsZWZ0OiAwLCB3aWR0aDogY2FudmFzLmNsaWVudFdpZHRoLCBoZWlnaHQ6IGNhbnZhcy5jbGllbnRIZWlnaHQgfSwKICAgICAgICAvLyBDYWxjdWxhdGUgdGhlIHRocmVzaG9sZCB0aW1lIGZvciB0aGUgb2xkZXN0IGRhdGEgcG9pbnRzLgogICAgICAgIG9sZGVzdFZhbGlkVGltZSA9IHRpbWUgLSAoZGltZW5zaW9ucy53aWR0aCAqIGNoYXJ0T3B0aW9ucy5taWxsaXNQZXJQaXhlbCksCiAgICAgICAgdmFsdWVUb1lQaXhlbCA9IGZ1bmN0aW9uKHZhbHVlKSB7CiAgICAgICAgICB2YXIgb2Zmc2V0ID0gdmFsdWUgLSB0aGlzLmN1cnJlbnRWaXNNaW5WYWx1ZTsKICAgICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRWYWx1ZVJhbmdlID09PSAwCiAgICAgICAgICAgID8gZGltZW5zaW9ucy5oZWlnaHQKICAgICAgICAgICAgOiBkaW1lbnNpb25zLmhlaWdodCAtIChNYXRoLnJvdW5kKChvZmZzZXQgLyB0aGlzLmN1cnJlbnRWYWx1ZVJhbmdlKSAqIGRpbWVuc2lvbnMuaGVpZ2h0KSk7CiAgICAgICAgfS5iaW5kKHRoaXMpLAogICAgICAgIHRpbWVUb1hQaXhlbCA9IGZ1bmN0aW9uKHQpIHsKICAgICAgICAgIGlmKGNoYXJ0T3B0aW9ucy5zY3JvbGxCYWNrd2FyZHMpIHsKICAgICAgICAgICAgcmV0dXJuIE1hdGgucm91bmQoKHRpbWUgLSB0KSAvIGNoYXJ0T3B0aW9ucy5taWxsaXNQZXJQaXhlbCk7CiAgICAgICAgICB9CiAgICAgICAgICByZXR1cm4gTWF0aC5yb3VuZChkaW1lbnNpb25zLndpZHRoIC0gKCh0aW1lIC0gdCkgLyBjaGFydE9wdGlvbnMubWlsbGlzUGVyUGl4ZWwpKTsKICAgICAgICB9OwoKICAgIHRoaXMudXBkYXRlVmFsdWVSYW5nZSgpOwoKICAgIGNvbnRleHQuZm9udCA9IGNoYXJ0T3B0aW9ucy5sYWJlbHMuZm9udFNpemUgKyAncHggJyArIGNoYXJ0T3B0aW9ucy5sYWJlbHMuZm9udEZhbWlseTsKCiAgICAvLyBTYXZlIHRoZSBzdGF0ZSBvZiB0aGUgY2FudmFzIGNvbnRleHQsIGFueSB0cmFuc2Zvcm1hdGlvbnMgYXBwbGllZCBpbiB0aGlzIG1ldGhvZAogICAgLy8gd2lsbCBnZXQgcmVtb3ZlZCBmcm9tIHRoZSBzdGFjayBhdCB0aGUgZW5kIG9mIHRoaXMgbWV0aG9kIHdoZW4gLnJlc3RvcmUoKSBpcyBjYWxsZWQuCiAgICBjb250ZXh0LnNhdmUoKTsKCiAgICAvLyBNb3ZlIHRoZSBvcmlnaW4uCiAgICBjb250ZXh0LnRyYW5zbGF0ZShkaW1lbnNpb25zLmxlZnQsIGRpbWVuc2lvbnMudG9wKTsKCiAgICAvLyBDcmVhdGUgYSBjbGlwcGVkIHJlY3RhbmdsZSAtIGFueXRoaW5nIHdlIGRyYXcgd2lsbCBiZSBjb25zdHJhaW5lZCB0byB0aGlzIHJlY3RhbmdsZS4KICAgIC8vIFRoaXMgcHJldmVudHMgdGhlIG9jY2FzaW9uYWwgcGl4ZWxzIGZyb20gY3VydmVzIG5lYXIgdGhlIGVkZ2VzIG92ZXJydW5uaW5nIGFuZCBjcmVhdGluZwogICAgLy8gc2NyZWVuIGNoZWVzZSAodGhhdCBwaHJhc2Ugc2hvdWxkIG5lZWQgbm8gZXhwbGFuYXRpb24pLgogICAgY29udGV4dC5iZWdpblBhdGgoKTsKICAgIGNvbnRleHQucmVjdCgwLCAwLCBkaW1lbnNpb25zLndpZHRoLCBkaW1lbnNpb25zLmhlaWdodCk7CiAgICBjb250ZXh0LmNsaXAoKTsKCiAgICAvLyBDbGVhciB0aGUgd29ya2luZyBhcmVhLgogICAgY29udGV4dC5zYXZlKCk7CiAgICBjb250ZXh0LmZpbGxTdHlsZSA9IGNoYXJ0T3B0aW9ucy5ncmlkLmZpbGxTdHlsZTsKICAgIGNvbnRleHQuY2xlYXJSZWN0KDAsIDAsIGRpbWVuc2lvbnMud2lkdGgsIGRpbWVuc2lvbnMuaGVpZ2h0KTsKICAgIGNvbnRleHQuZmlsbFJlY3QoMCwgMCwgZGltZW5zaW9ucy53aWR0aCwgZGltZW5zaW9ucy5oZWlnaHQpOwogICAgY29udGV4dC5yZXN0b3JlKCk7CgogICAgLy8gR3JpZCBsaW5lcy4uLgogICAgY29udGV4dC5zYXZlKCk7CiAgICBjb250ZXh0LmxpbmVXaWR0aCA9IGNoYXJ0T3B0aW9ucy5ncmlkLmxpbmVXaWR0aDsKICAgIGNvbnRleHQuc3Ryb2tlU3R5bGUgPSBjaGFydE9wdGlvbnMuZ3JpZC5zdHJva2VTdHlsZTsKICAgIC8vIFZlcnRpY2FsICh0aW1lKSBkaXZpZGVycy4KICAgIGlmIChjaGFydE9wdGlvbnMuZ3JpZC5taWxsaXNQZXJMaW5lID4gMCkgewogICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICBmb3IgKHZhciB0ID0gdGltZSAtICh0aW1lICUgY2hhcnRPcHRpb25zLmdyaWQubWlsbGlzUGVyTGluZSk7CiAgICAgICAgICAgdCA+PSBvbGRlc3RWYWxpZFRpbWU7CiAgICAgICAgICAgdCAtPSBjaGFydE9wdGlvbnMuZ3JpZC5taWxsaXNQZXJMaW5lKSB7CiAgICAgICAgdmFyIGd4ID0gdGltZVRvWFBpeGVsKHQpOwogICAgICAgIGlmIChjaGFydE9wdGlvbnMuZ3JpZC5zaGFycExpbmVzKSB7CiAgICAgICAgICBneCAtPSAwLjU7CiAgICAgICAgfQogICAgICAgIGNvbnRleHQubW92ZVRvKGd4LCAwKTsKICAgICAgICBjb250ZXh0LmxpbmVUbyhneCwgZGltZW5zaW9ucy5oZWlnaHQpOwogICAgICB9CiAgICAgIGNvbnRleHQuc3Ryb2tlKCk7CiAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB9CgogICAgLy8gSG9yaXpvbnRhbCAodmFsdWUpIGRpdmlkZXJzLgogICAgZm9yICh2YXIgdiA9IDE7IHYgPCBjaGFydE9wdGlvbnMuZ3JpZC52ZXJ0aWNhbFNlY3Rpb25zOyB2KyspIHsKICAgICAgdmFyIGd5ID0gTWF0aC5yb3VuZCh2ICogZGltZW5zaW9ucy5oZWlnaHQgLyBjaGFydE9wdGlvbnMuZ3JpZC52ZXJ0aWNhbFNlY3Rpb25zKTsKICAgICAgaWYgKGNoYXJ0T3B0aW9ucy5ncmlkLnNoYXJwTGluZXMpIHsKICAgICAgICBneSAtPSAwLjU7CiAgICAgIH0KICAgICAgY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgY29udGV4dC5tb3ZlVG8oMCwgZ3kpOwogICAgICBjb250ZXh0LmxpbmVUbyhkaW1lbnNpb25zLndpZHRoLCBneSk7CiAgICAgIGNvbnRleHQuc3Ryb2tlKCk7CiAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICB9CiAgICAvLyBCb3VuZGluZyByZWN0YW5nbGUuCiAgICBpZiAoY2hhcnRPcHRpb25zLmdyaWQuYm9yZGVyVmlzaWJsZSkgewogICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICBjb250ZXh0LnN0cm9rZVJlY3QoMCwgMCwgZGltZW5zaW9ucy53aWR0aCwgZGltZW5zaW9ucy5oZWlnaHQpOwogICAgICBjb250ZXh0LmNsb3NlUGF0aCgpOwogICAgfQogICAgY29udGV4dC5yZXN0b3JlKCk7CgogICAgLy8gRHJhdyBhbnkgaG9yaXpvbnRhbCBsaW5lcy4uLgogICAgaWYgKGNoYXJ0T3B0aW9ucy5ob3Jpem9udGFsTGluZXMgJiYgY2hhcnRPcHRpb25zLmhvcml6b250YWxMaW5lcy5sZW5ndGgpIHsKICAgICAgZm9yICh2YXIgaGwgPSAwOyBobCA8IGNoYXJ0T3B0aW9ucy5ob3Jpem9udGFsTGluZXMubGVuZ3RoOyBobCsrKSB7CiAgICAgICAgdmFyIGxpbmUgPSBjaGFydE9wdGlvbnMuaG9yaXpvbnRhbExpbmVzW2hsXSwKICAgICAgICAgICAgaGx5ID0gTWF0aC5yb3VuZCh2YWx1ZVRvWVBpeGVsKGxpbmUudmFsdWUpKSAtIDAuNTsKICAgICAgICBjb250ZXh0LnN0cm9rZVN0eWxlID0gbGluZS5jb2xvciB8fCAnI2ZmZmZmZic7CiAgICAgICAgY29udGV4dC5saW5lV2lkdGggPSBsaW5lLmxpbmVXaWR0aCB8fCAxOwogICAgICAgIGNvbnRleHQuYmVnaW5QYXRoKCk7CiAgICAgICAgY29udGV4dC5tb3ZlVG8oMCwgaGx5KTsKICAgICAgICBjb250ZXh0LmxpbmVUbyhkaW1lbnNpb25zLndpZHRoLCBobHkpOwogICAgICAgIGNvbnRleHQuc3Ryb2tlKCk7CiAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgfQogICAgfQoKICAgIC8vIEZvciBlYWNoIGRhdGEgc2V0Li4uCiAgICBmb3IgKHZhciBkID0gMDsgZCA8IHRoaXMuc2VyaWVzU2V0Lmxlbmd0aDsgZCsrKSB7CiAgICAgIGNvbnRleHQuc2F2ZSgpOwogICAgICB2YXIgdGltZVNlcmllcyA9IHRoaXMuc2VyaWVzU2V0W2RdLnRpbWVTZXJpZXMsCiAgICAgICAgICBkYXRhU2V0ID0gdGltZVNlcmllcy5kYXRhLAogICAgICAgICAgc2VyaWVzT3B0aW9ucyA9IHRoaXMuc2VyaWVzU2V0W2RdLm9wdGlvbnM7CgogICAgICAvLyBEZWxldGUgb2xkIGRhdGEgdGhhdCdzIG1vdmVkIG9mZiB0aGUgbGVmdCBvZiB0aGUgY2hhcnQuCiAgICAgIHRpbWVTZXJpZXMuZHJvcE9sZERhdGEob2xkZXN0VmFsaWRUaW1lLCBjaGFydE9wdGlvbnMubWF4RGF0YVNldExlbmd0aCk7CgogICAgICAvLyBTZXQgc3R5bGUgZm9yIHRoaXMgZGF0YVNldC4KICAgICAgY29udGV4dC5saW5lV2lkdGggPSBzZXJpZXNPcHRpb25zLmxpbmVXaWR0aDsKICAgICAgY29udGV4dC5zdHJva2VTdHlsZSA9IHNlcmllc09wdGlvbnMuc3Ryb2tlU3R5bGU7CiAgICAgIC8vIERyYXcgdGhlIGxpbmUuLi4KICAgICAgY29udGV4dC5iZWdpblBhdGgoKTsKICAgICAgLy8gUmV0YWluIGxhc3RYLCBsYXN0WSBmb3IgY2FsY3VsYXRpbmcgdGhlIGNvbnRyb2wgcG9pbnRzIG9mIGJlemllciBjdXJ2ZXMuCiAgICAgIHZhciBmaXJzdFggPSAwLCBsYXN0WCA9IDAsIGxhc3RZID0gMDsKICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBkYXRhU2V0Lmxlbmd0aCAmJiBkYXRhU2V0Lmxlbmd0aCAhPT0gMTsgaSsrKSB7CiAgICAgICAgdmFyIHggPSB0aW1lVG9YUGl4ZWwoZGF0YVNldFtpXVswXSksCiAgICAgICAgICAgIHkgPSB2YWx1ZVRvWVBpeGVsKGRhdGFTZXRbaV1bMV0pOwoKICAgICAgICBpZiAoaSA9PT0gMCkgewogICAgICAgICAgZmlyc3RYID0geDsKICAgICAgICAgIGNvbnRleHQubW92ZVRvKHgsIHkpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBzd2l0Y2ggKGNoYXJ0T3B0aW9ucy5pbnRlcnBvbGF0aW9uKSB7CiAgICAgICAgICAgIGNhc2UgImxpbmVhciI6CiAgICAgICAgICAgIGNhc2UgImxpbmUiOiB7CiAgICAgICAgICAgICAgY29udGV4dC5saW5lVG8oeCx5KTsKICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYXNlICJiZXppZXIiOgogICAgICAgICAgICBkZWZhdWx0OiB7CiAgICAgICAgICAgICAgLy8gR3JlYXQgZXhwbGFuYXRpb24gb2YgQmV6aWVyIGN1cnZlczogaHR0cDovL2VuLndpa2lwZWRpYS5vcmcvd2lraS9CZXppZXJfY3VydmUjUXVhZHJhdGljX2N1cnZlcwogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgLy8gQXNzdW1pbmcgQSB3YXMgdGhlIGxhc3QgcG9pbnQgaW4gdGhlIGxpbmUgcGxvdHRlZCBhbmQgQiBpcyB0aGUgbmV3IHBvaW50LAogICAgICAgICAgICAgIC8vIHdlIGRyYXcgYSBjdXJ2ZSB3aXRoIGNvbnRyb2wgcG9pbnRzIFAgYW5kIFEgYXMgYmVsb3cuCiAgICAgICAgICAgICAgLy8KICAgICAgICAgICAgICAvLyBBLS0tUAogICAgICAgICAgICAgIC8vICAgICB8CiAgICAgICAgICAgICAgLy8gICAgIHwKICAgICAgICAgICAgICAvLyAgICAgfAogICAgICAgICAgICAgIC8vICAgICBRLS0tQgogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgLy8gSW1wb3J0YW50bHksIEEgYW5kIFAgYXJlIGF0IHRoZSBzYW1lIHkgY29vcmRpbmF0ZSwgYXMgYXJlIEIgYW5kIFEuIFRoaXMgaXMKICAgICAgICAgICAgICAvLyBzbyBhZGphY2VudCBjdXJ2ZXMgYXBwZWFyIHRvIGZsb3cgYXMgb25lLgogICAgICAgICAgICAgIC8vCiAgICAgICAgICAgICAgY29udGV4dC5iZXppZXJDdXJ2ZVRvKCAvLyBzdGFydFBvaW50IChBKSBpcyBpbXBsaWNpdCBmcm9tIGxhc3QgaXRlcmF0aW9uIG9mIGxvb3AKICAgICAgICAgICAgICAgIE1hdGgucm91bmQoKGxhc3RYICsgeCkgLyAyKSwgbGFzdFksIC8vIGNvbnRyb2xQb2ludDEgKFApCiAgICAgICAgICAgICAgICBNYXRoLnJvdW5kKChsYXN0WCArIHgpKSAvIDIsIHksIC8vIGNvbnRyb2xQb2ludDIgKFEpCiAgICAgICAgICAgICAgICB4LCB5KTsgLy8gZW5kUG9pbnQgKEIpCiAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2FzZSAic3RlcCI6IHsKICAgICAgICAgICAgICBjb250ZXh0LmxpbmVUbyh4LGxhc3RZKTsKICAgICAgICAgICAgICBjb250ZXh0LmxpbmVUbyh4LHkpOwogICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsYXN0WCA9IHg7IGxhc3RZID0geTsKICAgICAgfQoKICAgICAgaWYgKGRhdGFTZXQubGVuZ3RoID4gMSkgewogICAgICAgIGlmIChzZXJpZXNPcHRpb25zLmZpbGxTdHlsZSkgewogICAgICAgICAgLy8gQ2xvc2UgdXAgdGhlIGZpbGwgcmVnaW9uLgogICAgICAgICAgY29udGV4dC5saW5lVG8oZGltZW5zaW9ucy53aWR0aCArIHNlcmllc09wdGlvbnMubGluZVdpZHRoICsgMSwgbGFzdFkpOwogICAgICAgICAgY29udGV4dC5saW5lVG8oZGltZW5zaW9ucy53aWR0aCArIHNlcmllc09wdGlvbnMubGluZVdpZHRoICsgMSwgZGltZW5zaW9ucy5oZWlnaHQgKyBzZXJpZXNPcHRpb25zLmxpbmVXaWR0aCArIDEpOwogICAgICAgICAgY29udGV4dC5saW5lVG8oZmlyc3RYLCBkaW1lbnNpb25zLmhlaWdodCArIHNlcmllc09wdGlvbnMubGluZVdpZHRoKTsKICAgICAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gc2VyaWVzT3B0aW9ucy5maWxsU3R5bGU7CiAgICAgICAgICBjb250ZXh0LmZpbGwoKTsKICAgICAgICB9CgogICAgICAgIGlmIChzZXJpZXNPcHRpb25zLnN0cm9rZVN0eWxlICYmIHNlcmllc09wdGlvbnMuc3Ryb2tlU3R5bGUgIT09ICdub25lJykgewogICAgICAgICAgY29udGV4dC5zdHJva2UoKTsKICAgICAgICB9CiAgICAgICAgY29udGV4dC5jbG9zZVBhdGgoKTsKICAgICAgfQogICAgICBjb250ZXh0LnJlc3RvcmUoKTsKICAgIH0KCiAgICBpZiAoY2hhcnRPcHRpb25zLnRvb2x0aXAgJiYgdGhpcy5tb3VzZVggPj0gMCkgewogICAgICAvLyBEcmF3IHZlcnRpY2FsIGJhciB0byBzaG93IHRvb2x0aXAgcG9zaXRpb24KICAgICAgY29udGV4dC5saW5lV2lkdGggPSBjaGFydE9wdGlvbnMudG9vbHRpcExpbmUubGluZVdpZHRoOwogICAgICBjb250ZXh0LnN0cm9rZVN0eWxlID0gY2hhcnRPcHRpb25zLnRvb2x0aXBMaW5lLnN0cm9rZVN0eWxlOwogICAgICBjb250ZXh0LmJlZ2luUGF0aCgpOwogICAgICBjb250ZXh0Lm1vdmVUbyh0aGlzLm1vdXNlWCwgMCk7CiAgICAgIGNvbnRleHQubGluZVRvKHRoaXMubW91c2VYLCBkaW1lbnNpb25zLmhlaWdodCk7CiAgICAgIGNvbnRleHQuY2xvc2VQYXRoKCk7CiAgICAgIGNvbnRleHQuc3Ryb2tlKCk7CiAgICAgIHRoaXMudXBkYXRlVG9vbHRpcCgpOwogICAgfQoKICAgIC8vIERyYXcgdGhlIGF4aXMgdmFsdWVzIG9uIHRoZSBjaGFydC4KICAgIGlmICghY2hhcnRPcHRpb25zLmxhYmVscy5kaXNhYmxlZCAmJiAhaXNOYU4odGhpcy52YWx1ZVJhbmdlLm1pbikgJiYgIWlzTmFOKHRoaXMudmFsdWVSYW5nZS5tYXgpKSB7CiAgICAgIHZhciBtYXhWYWx1ZVN0cmluZyA9IGNoYXJ0T3B0aW9ucy55TWF4Rm9ybWF0dGVyKHRoaXMudmFsdWVSYW5nZS5tYXgsIGNoYXJ0T3B0aW9ucy5sYWJlbHMucHJlY2lzaW9uKSwKICAgICAgICAgIG1pblZhbHVlU3RyaW5nID0gY2hhcnRPcHRpb25zLnlNaW5Gb3JtYXR0ZXIodGhpcy52YWx1ZVJhbmdlLm1pbiwgY2hhcnRPcHRpb25zLmxhYmVscy5wcmVjaXNpb24pLAogICAgICAgICAgbWF4TGFiZWxQb3MgPSBjaGFydE9wdGlvbnMuc2Nyb2xsQmFja3dhcmRzID8gMCA6IGRpbWVuc2lvbnMud2lkdGggLSBjb250ZXh0Lm1lYXN1cmVUZXh0KG1heFZhbHVlU3RyaW5nKS53aWR0aCAtIDIsCiAgICAgICAgICBtaW5MYWJlbFBvcyA9IGNoYXJ0T3B0aW9ucy5zY3JvbGxCYWNrd2FyZHMgPyAwIDogZGltZW5zaW9ucy53aWR0aCAtIGNvbnRleHQubWVhc3VyZVRleHQobWluVmFsdWVTdHJpbmcpLndpZHRoIC0gMjsKICAgICAgY29udGV4dC5maWxsU3R5bGUgPSBjaGFydE9wdGlvbnMubGFiZWxzLmZpbGxTdHlsZTsKICAgICAgY29udGV4dC5maWxsVGV4dChtYXhWYWx1ZVN0cmluZywgbWF4TGFiZWxQb3MsIGNoYXJ0T3B0aW9ucy5sYWJlbHMuZm9udFNpemUpOwogICAgICBjb250ZXh0LmZpbGxUZXh0KG1pblZhbHVlU3RyaW5nLCBtaW5MYWJlbFBvcywgZGltZW5zaW9ucy5oZWlnaHQgLSAyKTsKICAgIH0KCiAgICAvLyBEaXNwbGF5IHRpbWVzdGFtcHMgYWxvbmcgeC1heGlzIGF0IHRoZSBib3R0b20gb2YgdGhlIGNoYXJ0LgogICAgaWYgKGNoYXJ0T3B0aW9ucy50aW1lc3RhbXBGb3JtYXR0ZXIgJiYgY2hhcnRPcHRpb25zLmdyaWQubWlsbGlzUGVyTGluZSA+IDApIHsKICAgICAgdmFyIHRleHRVbnRpbFggPSBjaGFydE9wdGlvbnMuc2Nyb2xsQmFja3dhcmRzCiAgICAgICAgPyBjb250ZXh0Lm1lYXN1cmVUZXh0KG1pblZhbHVlU3RyaW5nKS53aWR0aAogICAgICAgIDogZGltZW5zaW9ucy53aWR0aCAtIGNvbnRleHQubWVhc3VyZVRleHQobWluVmFsdWVTdHJpbmcpLndpZHRoICsgNDsKICAgICAgZm9yICh2YXIgdCA9IHRpbWUgLSAodGltZSAlIGNoYXJ0T3B0aW9ucy5ncmlkLm1pbGxpc1BlckxpbmUpOwogICAgICAgICAgIHQgPj0gb2xkZXN0VmFsaWRUaW1lOwogICAgICAgICAgIHQgLT0gY2hhcnRPcHRpb25zLmdyaWQubWlsbGlzUGVyTGluZSkgewogICAgICAgIHZhciBneCA9IHRpbWVUb1hQaXhlbCh0KTsKICAgICAgICAvLyBPbmx5IGRyYXcgdGhlIHRpbWVzdGFtcCBpZiBpdCB3b24ndCBvdmVybGFwIHdpdGggdGhlIHByZXZpb3VzbHkgZHJhd24gb25lLgogICAgICAgIGlmICgoIWNoYXJ0T3B0aW9ucy5zY3JvbGxCYWNrd2FyZHMgJiYgZ3ggPCB0ZXh0VW50aWxYKSB8fCAoY2hhcnRPcHRpb25zLnNjcm9sbEJhY2t3YXJkcyAmJiBneCA+IHRleHRVbnRpbFgpKSAgewogICAgICAgICAgLy8gRm9ybWF0cyB0aGUgdGltZXN0YW1wIGJhc2VkIG9uIHVzZXIgc3BlY2lmaWVkIGZvcm1hdHRpbmcgZnVuY3Rpb24KICAgICAgICAgIC8vIFNtb290aGllQ2hhcnQudGltZUZvcm1hdHRlciBmdW5jdGlvbiBhYm92ZSBpcyBvbmUgc3VjaCBmb3JtYXR0aW5nIG9wdGlvbgogICAgICAgICAgdmFyIHR4ID0gbmV3IERhdGUodCksCiAgICAgICAgICAgIHRzID0gY2hhcnRPcHRpb25zLnRpbWVzdGFtcEZvcm1hdHRlcih0eCksCiAgICAgICAgICAgIHRzV2lkdGggPSBjb250ZXh0Lm1lYXN1cmVUZXh0KHRzKS53aWR0aDsKCiAgICAgICAgICB0ZXh0VW50aWxYID0gY2hhcnRPcHRpb25zLnNjcm9sbEJhY2t3YXJkcwogICAgICAgICAgICA/IGd4ICsgdHNXaWR0aCArIDIKICAgICAgICAgICAgOiBneCAtIHRzV2lkdGggLSAyOwoKICAgICAgICAgIGNvbnRleHQuZmlsbFN0eWxlID0gY2hhcnRPcHRpb25zLmxhYmVscy5maWxsU3R5bGU7CiAgICAgICAgICBpZihjaGFydE9wdGlvbnMuc2Nyb2xsQmFja3dhcmRzKSB7CiAgICAgICAgICAgIGNvbnRleHQuZmlsbFRleHQodHMsIGd4LCBkaW1lbnNpb25zLmhlaWdodCAtIDIpOwogICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29udGV4dC5maWxsVGV4dCh0cywgZ3ggLSB0c1dpZHRoLCBkaW1lbnNpb25zLmhlaWdodCAtIDIpOwogICAgICAgICAgfQogICAgICAgIH0KICAgICAgfQogICAgfQoKICAgIGNvbnRleHQucmVzdG9yZSgpOyAvLyBTZWUgLnNhdmUoKSBhYm92ZS4KICB9OwoKICAvLyBTYW1wbGUgdGltZXN0YW1wIGZvcm1hdHRpbmcgZnVuY3Rpb24KICBTbW9vdGhpZUNoYXJ0LnRpbWVGb3JtYXR0ZXIgPSBmdW5jdGlvbihkYXRlKSB7CiAgICBmdW5jdGlvbiBwYWQyKG51bWJlcikgeyByZXR1cm4gKG51bWJlciA8IDEwID8gJzAnIDogJycpICsgbnVtYmVyIH0KICAgIHJldHVybiBwYWQyKGRhdGUuZ2V0SG91cnMoKSkgKyAnOicgKyBwYWQyKGRhdGUuZ2V0TWludXRlcygpKSArICc6JyArIHBhZDIoZGF0ZS5nZXRTZWNvbmRzKCkpOwogIH07CgogIGV4cG9ydHMuVGltZVNlcmllcyA9IFRpbWVTZXJpZXM7CiAgZXhwb3J0cy5TbW9vdGhpZUNoYXJ0ID0gU21vb3RoaWVDaGFydDsKCn0pKHR5cGVvZiBleHBvcnRzID09PSAndW5kZWZpbmVkJyA/IHRoaXMgOiBleHBvcnRzKTsK")
